<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assessment Progress - ForeSITE</title>
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <!-- CryptoJS for Cloudinary signature -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
      :root {
        --maroon: #800000;
        --gold: #ffb81c;
        --light-gray: #f5f5f5;
        --dark-gray: #333;
        --border-radius: 8px;
        --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        --sidebar-width: 320px;
      }

      body {
        font-family: "Poppins", sans-serif;
        background-color: var(--light-gray);
        min-height: 100vh;
        overflow-x: hidden;
      }

      .navbar {
        background: var(--maroon);
        padding: 1rem 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 1030;
      }

      .navbar-brand {
        color: white !important;
        font-weight: 600;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .navbar-brand img {
        height: 35px;
      }

      .assessment-container {
        display: flex;
        margin-top: 56px;
      }

      .sidebar {
        width: var(--sidebar-width);
        background: white;
        height: calc(100vh - 56px);
        position: fixed;
        left: 0;
        overflow-y: auto;
        padding: 1.5rem;
        border-right: 1px solid #eee;
      }

      .main-content {
        margin-left: var(--sidebar-width);
        flex: 1;
        padding: 2rem;
        min-height: calc(100vh - 56px);
      }

      .module-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .module-item {
        margin-bottom: 1rem;
        border: 1px solid #eee;
        border-radius: var(--border-radius);
        overflow: hidden;
      }

      .module-header {
        padding: 1rem;
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .module-header:not(.locked):hover {
        background-color: #e9ecef;
        cursor: pointer;
      }

      .module-header.locked:hover {
        cursor: not-allowed;
      }

      .module-header.active {
        background: var(--maroon);
        color: white;
      }

      .module-header.completed {
        background: #d4edda;
        color: #155724;
        border-color: #c3e6cb;
      }

      .progress-indicator {
        margin-top: 2.5rem;
        margin-bottom: 2rem;
      }

      .progress {
        height: 0.5rem;
        background-color: #e9ecef;
        margin-top: 0.5rem;
      }

      .progress-bar {
        background-color: var(--maroon);
        border-radius: 4px;
      }

      .assessment-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
        overflow: hidden;
      }

      .assessment-header {
        padding: 1.5rem;
        border-bottom: 1px solid #eee;
        background: #f8f9fa;
      }

      .assessment-title {
        margin: 0;
        color: var(--maroon);
        font-size: 1.25rem;
        font-weight: 600;
      }

      .assessment-module {
        color: var(--dark-gray);
        font-size: 0.9rem;
        margin-top: 0.5rem;
      }

      .assessment-body {
        padding: 1.5rem;
      }

      .assessment-objective {
        color: var(--dark-gray);
        margin-bottom: 1.5rem;
      }

      .assessment-scenario {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: var(--border-radius);
        margin-bottom: 1.5rem;
      }

      .assessment-steps {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .assessment-step {
        padding: 1rem;
        border: 1px solid #eee;
        border-radius: var(--border-radius);
        margin-bottom: 1rem;
      }

      .step-title {
        font-weight: 600;
        color: var(--maroon);
        margin-bottom: 0.5rem;
      }

      .step-description {
        color: var(--dark-gray);
        white-space: pre-line;
      }

      .assessment-footer {
        padding: 1.5rem;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .status-badge {
        padding: 0.5rem 1rem;
        border-radius: var(--border-radius);
        font-size: 0.9rem;
        font-weight: 500;
      }

      .status-not-started {
        background-color: #f8f9fa;
        color: var(--dark-gray);
      }

      .status-in-progress {
        background-color: var(--gold);
        color: var(--dark-gray);
      }

      .status-completed {
        background-color: #28a745;
        color: white;
      }

      .btn-start-assessment {
        background: linear-gradient(to right, var(--maroon), #600000);
        color: white;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: var(--border-radius);
        font-weight: 500;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(128, 0, 0, 0.2);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-start-assessment:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(128, 0, 0, 0.3);
        color: white;
      }

      .btn-start-assessment[disabled] {
        opacity: 0.65;
        cursor: not-allowed;
        transform: none;
      }

      .btn-complete-assessment {
        background: linear-gradient(to right, var(--maroon), #600000);
        color: white;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: var(--border-radius);
        font-weight: 500;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(128, 0, 0, 0.2);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-complete-assessment:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(128, 0, 0, 0.3);
        color: white;
      }

      .btn-complete-assessment[disabled] {
        opacity: 0.65;
        cursor: not-allowed;
        transform: none;
      }

      /* Loading screen styles */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        color: white;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }

      .loading-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .loading-spinner {
        width: 80px;
        height: 80px;
        border: 8px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--gold);
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        font-size: 1.2rem;
        font-weight: 500;
        text-align: center;
        max-width: 80%;
        line-height: 1.6;
      }

      @media (max-width: 992px) {
        .sidebar {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
          z-index: 1020;
        }

        .sidebar.show {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }

        .toggle-sidebar {
          display: block;
        }
      }

      .content-footer {
        padding: 1.5rem;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .nav-button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        font-weight: 500;
      }

      .btn-back {
        background-color: #f8f9fa;
        color: var(--dark-gray);
      }

      .btn-back:hover {
        background-color: #e9ecef;
      }

      .btn-back[disabled] {
        opacity: 0.65;
        cursor: not-allowed;
      }

      .btn-continue {
        background: linear-gradient(to right, var(--maroon), #600000);
        color: white;
        box-shadow: 0 4px 15px rgba(128, 0, 0, 0.2);
      }

      .btn-continue:hover {
        background: linear-gradient(to right, #600000, #400000);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(128, 0, 0, 0.3);
      }

      .btn-continue[disabled] {
        opacity: 0.65;
        cursor: not-allowed;
        transform: none;
      }

      .module-header.locked {
        background-color: #f8f9fa;
        color: #6c757d;
        cursor: not-allowed;
      }

      .module-header.locked .badge {
        background-color: #6c757d;
      }

      .assessment-item {
        transition: all 0.2s ease;
      }

      .assessment-item:not(.disabled):hover {
        background-color: #f8f9fa;
        cursor: pointer;
      }

      .assessment-item.disabled:hover {
        cursor: not-allowed;
      }

      .assessment-item.active {
        background-color: #f8f9fa;
        color: var(--maroon);
        border-left: 3px solid var(--maroon);
      }

      .assessment-item.completed:hover {
        cursor: pointer;
      }

      .assessment-item.completed i {
        color: #28a745;
      }

      .spacer {
        flex: 1;
      }

      /* Updated File Upload Styles */
      .file-upload-container {
        margin-top: 1rem;
        padding: 1.5rem;
        border: 2px dashed #ccc;
        border-radius: var(--border-radius);
        text-align: center;
        transition: all 0.3s ease;
      }

      .file-upload-container.drag-over {
        border-color: var(--maroon);
        background-color: rgba(128, 0, 0, 0.05);
      }

      .file-upload-input {
        display: none;
      }

      .file-upload-label {
        cursor: pointer;
        padding: 1rem;
        display: block;
      }

      .file-upload-label i {
        color: var(--maroon);
        margin-bottom: 1rem;
      }

      .file-upload-progress {
        margin-top: 1rem;
        display: none;
      }

      .file-upload-preview {
        margin-top: 1rem;
        padding: 1rem;
        border: 1px solid #eee;
        border-radius: var(--border-radius);
        display: none;
      }

      .file-preview-content {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .file-preview-icon {
        font-size: 2.5rem;
        color: var(--maroon);
      }

      .file-preview-image {
        max-width: 100px;
        max-height: 100px;
        border-radius: var(--border-radius);
        object-fit: cover;
      }

      .file-preview-details {
        flex: 1;
        text-align: left;
      }

      .file-name {
        font-weight: 500;
        margin-bottom: 0.25rem;
        word-break: break-all;
      }

      .file-size {
        color: #6c757d;
        font-size: 0.875rem;
      }

      .file-type-icon {
        font-size: 2.5rem;
        width: 100px;
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        border-radius: var(--border-radius);
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <div id="navbar-placeholder"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loadingText">
        Loading your assessment progress...
      </div>
    </div>

    <div class="assessment-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="progress-indicator">
          <div class="d-flex justify-content-between align-items-center">
            <span>Assessment Progress</span>
            <span class="progress-text">0%</span>
          </div>
          <div class="progress">
            <div
              class="progress-bar"
              role="progressbar"
              style="width: 0%"
              aria-valuenow="0"
              aria-valuemin="0"
              aria-valuemax="100"
            ></div>
          </div>
        </div>

        <ul class="module-list" id="module-list">
          <!-- Modules will be loaded here dynamically -->
        </ul>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="container-fluid">
          <div id="assessment-container">
            <!-- Current assessment will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Updated File Upload Modal -->
    <div class="modal fade" id="fileUploadModal" tabindex="-1" aria-labelledby="fileUploadModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="fileUploadModalLabel">Submit Assessment File</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="file-upload-container" id="dropZone">
              <label class="file-upload-label">
                <i class="fas fa-cloud-upload-alt fa-3x"></i>
                <p class="mb-1">Drag & Drop your file here</p>
                <p class="text-muted small mb-0">or</p>
                <button type="button" class="btn btn-outline-primary mt-2" id="browseButton">Browse Files</button>
                <input type="file" class="file-upload-input" id="fileUpload">
              </label>
            </div>
            <div class="file-upload-preview">
              <div class="file-preview-content">
                <div class="file-type-icon">
                  <i class="fas fa-file"></i>
                </div>
                <div class="file-preview-details">
                  <div class="file-name" id="fileName">No file selected</div>
                  <div class="file-size" id="fileSize"></div>
                  <div class="file-type" id="fileType"></div>
                </div>
              </div>
            </div>
            <div class="file-upload-progress">
              <div class="progress">
                <div class="progress-bar bg-maroon" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <div class="text-center mt-2" id="uploadStatus">Uploading...</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="uploadSubmitBtn" disabled>Submit</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $(document).ready(function () {
        // Load navbar
        $("#navbar-placeholder").load("../components/navbar.html");

        // Get user data from session storage
        const userData = JSON.parse(sessionStorage.getItem("user"));
        if (!userData) {
          window.location.href = "../login.html";
          return;
        }

        let currentAssessment = null;
        let allAssessments = [];

        // Show loading overlay
        const loadingOverlay = document.getElementById("loadingOverlay");
        const loadingText = document.getElementById("loadingText");
        loadingOverlay.classList.add("active");

        // Fetch assessment progress
        fetchAssessmentProgress(userData.user_id);

        function fetchAssessmentProgress(userId) {
          console.log("Fetching assessment progress for user:", userId);
          
          fetch(`http://127.0.0.1:8000/api/v1/users/${userId}/assessment-progress`)
            .then((response) => {
              console.log("Response received:", response);
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then((data) => {
              console.log("Assessment data received:", data);
              
              if (!data || !data.data || !Array.isArray(data.data)) {
                throw new Error("Invalid data format received");
              }

              allAssessments = data.data;
              
              if (allAssessments.length === 0) {
                // Handle no assessments case
                const container = $("#assessment-container");
                container.html(`
                  <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    No assessments are available at this time.
                  </div>
                `);
                loadingOverlay.classList.remove("active");
                return;
              }

              buildModuleList(allAssessments);
              updateProgressIndicator(allAssessments);

              // Find the first incomplete assessment or first assessment if all completed
              currentAssessment = allAssessments.find(a => a.status !== "completed") || allAssessments[0];
              
              if (currentAssessment) {
                console.log("Setting current assessment:", currentAssessment);
                displayCurrentAssessment();
              }

              // Hide loading overlay
              setTimeout(() => {
                loadingOverlay.classList.remove("active");
              }, 500);
            })
            .catch((error) => {
              console.error("Error loading assessment progress:", error);
              
              // Show error message in the main container
              const container = $("#assessment-container");
              container.html(`
                <div class="alert alert-danger">
                  <i class="fas fa-exclamation-circle"></i>
                  Error loading assessment progress. Please try refreshing the page.
                  <br>
                  <small class="text-muted">${error.message}</small>
                </div>
              `);

              loadingText.textContent = "Error loading assessment progress. Please try again later.";
              setTimeout(() => {
                loadingOverlay.classList.remove("active");
              }, 1000);
            });
        }

        function displayCurrentAssessment() {
          if (!currentAssessment) return;

          // Scroll to top of the page
          window.scrollTo(0, 0);
          // Also scroll the main content area to top
          $(".main-content").scrollTop(0);

          const container = $("#assessment-container");
          container.empty();

          const card = createAssessmentCard(currentAssessment);
          container.append(card);

          // Update sidebar active state
          $(".assessment-item").removeClass("active");
          $(`.assessment-item[data-assessment-id="${currentAssessment.assessment_progress_id}"]`).addClass("active");

          // Expand the current module in sidebar
          const currentModuleHeader = $(`.assessment-item[data-assessment-id="${currentAssessment.assessment_progress_id}"]`)
            .closest(".module-item")
            .find(".module-header");
          
          currentModuleHeader.siblings(".assessment-list").slideDown();
          currentModuleHeader.find(".fa-chevron-down").addClass("fa-chevron-up");

          updateNavigationButtons();
        }

        function createAssessmentCard(assessment) {
          const isModuleLocked = !assessment.module_progress?.status || assessment.module_progress.status !== 'completed';
          const isCompleted = assessment.status === "completed";
          
          const card = $(`
            <div class="assessment-card" data-assessment-id="${assessment.assessment_progress_id}">
              <div class="assessment-header">
                <h3 class="assessment-title">${assessment.assessment.assessment_title}</h3>
                <div class="assessment-module">Module ${assessment.assessment.module_number}</div>
                ${!isCompleted && isModuleLocked ? 
                  '<div class="alert alert-warning mt-2 mb-0"><i class="fas fa-exclamation-triangle me-2"></i>You must complete this module before submitting the assessment.</div>' 
                  : ''}
                ${isCompleted && assessment.file_url ? 
                  `<div class="alert alert-success mt-2 mb-0">
                    <i class="fas fa-check-circle me-2"></i>Assessment completed
                    <a href="${assessment.file_url}" target="_blank" class="btn btn-sm btn-outline-success ms-2">
                      <i class="fas fa-download me-1"></i>View Submission
                    </a>
                   </div>`
                  : ''}
                ${!isCompleted && !isModuleLocked && assessment.file_url ?
                    `<div class="alert alert-warning mt-2 mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Please review the feedback below and resubmit your assessment.
                    </div>`
                : ''}
              </div>
              <div class="assessment-body">
                ${assessment.assessment.assessment_objective
                  ? `<div class="assessment-objective">
                       <strong>Objective:</strong> ${assessment.assessment.assessment_objective}
                     </div>`
                  : ""}
                ${assessment.assessment.assessment_scenario
                  ? `<div class="assessment-scenario">
                       <strong>Scenario:</strong><br>
                       ${assessment.assessment.assessment_scenario}
                     </div>`
                  : ""}
                <div class="assessment-steps">
                  <h4 class="mb-3">Assessment Steps:</h4>
                  ${assessment.assessment.assessment_instructions
                    .map(
                      (step) => `
                    <div class="assessment-step">
                      <div class="step-title">${step.step_title}</div>
                      <div class="step-description">${step.step_description}</div>
                    </div>
                  `
                    )
                    .join("")}
                </div>
                <div class="faculty-feedback-container mt-4"></div>
              </div>
              <div class="content-footer">
                <button class="nav-button btn-back" ${getPreviousAssessment() ? '' : 'disabled'}>
                  <i class="fas fa-arrow-left"></i> Back
                </button>
                <div class="spacer"></div>
                ${isCompleted ? 
                  `<button class="btn btn-success" disabled>
                    <i class="fas fa-check"></i> Completed
                   </button>
                   ${assessment.file_url ? 
                     `<a href="${assessment.file_url}" target="_blank" class="btn btn-outline-primary ms-2">
                        <i class="fas fa-download me-1"></i>View Submission
                      </a>` 
                     : ''}`
                  : `<button class="btn-complete-assessment" onclick="completeAssessment(${assessment.assessment_progress_id})" 
                      ${isModuleLocked ? "disabled" : ""}>
                      ${isModuleLocked ? '<i class="fas fa-lock"></i> Locked' : '<i class="fas fa-check"></i> Complete Assessment'}
                     </button>`
                }
              </div>
            </div>
          `);

          // Add navigation button handlers
          card.find('.btn-back').click(() => navigateAssessment('prev'));
          card.find('.btn-continue').click(() => navigateAssessment('next'));

          if (assessment.file_url || isCompleted) {
            const feedbackContainer = card.find('.faculty-feedback-container');
            loadAndDisplayFacultyFeedback(assessment, feedbackContainer);
          }

          return card;
        }

        function loadAndDisplayFacultyFeedback(assessment, container) {
            const progressId = assessment.assessment_progress_id;
            
            container.html(`
                <div class="text-center p-3">
                    <div class="spinner-border spinner-border-sm text-muted" role="status"></div>
                    <span class="ms-2 text-muted">Loading feedback...</span>
                </div>
            `);

            const scorePromise = fetch(`http://127.0.0.1:8000/api/v1/scores/assessment-progress/${progressId}`).then(res => res.json().catch(() => ({ data: null })));
            const feedbackPromise = fetch(`http://127.0.0.1:8000/api/v1/feedback/assessment-progress/${progressId}`).then(res => res.json().catch(() => ({ data: null })));

            Promise.all([scorePromise, feedbackPromise])
                .then(([scoreResponse, feedbackResponse]) => {
                    const scoreData = (scoreResponse && scoreResponse.data && scoreResponse.data.length > 0) ? scoreResponse.data[0] : null;
                    const feedbackData = (feedbackResponse && feedbackResponse.data && feedbackResponse.data.length > 0) ? feedbackResponse.data[0] : null;

                    if (scoreData || feedbackData) {
                        let scoreStatus = '';
                        let scoreStatusClass = '';
                        let isPassed = false;

                        if(scoreData) {
                            if (scoreData.score <= 2) {
                                scoreStatus = 'Failed';
                                scoreStatusClass = 'text-danger';
                            } else {
                                scoreStatus = 'Passed';
                                scoreStatusClass = 'text-success';
                                isPassed = true;
                            }
                        }

                        let feedbackHTML = `
                            <div style="background-color: #f8f9fa; border-radius: var(--border-radius); padding: 1.5rem;">
                                <h5 class="mb-3" style="color: var(--maroon);"><i class="fas fa-user-graduate me-2"></i>Faculty Feedback</h5>`;
                        
                        if (scoreData) {
                             feedbackHTML += `
                                <p class="mb-2">
                                    <strong>Score:</strong> ${scoreData.score}/5 
                                    <span class="fw-bold ${scoreStatusClass}">(${scoreStatus})</span>
                                </p>`;
                        } else {
                            feedbackHTML += `<p class="mb-2 text-muted">No score has been given yet.</p>`;
                        }

                        if (feedbackData) {
                             feedbackHTML += `
                                <p class="mb-1"><strong>Feedback:</strong></p>
                                <blockquote class="blockquote">
                                    <p class="mb-0 small">${feedbackData.feedback}</p>
                                </blockquote>`;
                        } else {
                            feedbackHTML += `<p class="mb-1 text-muted">No feedback has been given yet.</p>`;
                        }
                        
                        feedbackHTML += `</div>`;
                        container.html(feedbackHTML);

                        if (isPassed) {
                            const certificateContainer = document.createElement('div');
                            certificateContainer.className = 'mt-3';
                            container.append(certificateContainer);
                            handleCertificateButton(assessment, certificateContainer);
                        }

                    } else {
                        container.html(`
                            <div class="text-center text-muted p-3 border rounded">
                                <i class="fas fa-info-circle me-1"></i>
                                Your assessment has been submitted. Feedback will appear here once it's reviewed.
                            </div>
                        `);
                    }
                })
                .catch(error => {
                    console.error(`Error loading feedback for assessment progress ${progressId}:`, error);
                    container.html('<div class="alert alert-warning">Could not load feedback.</div>');
                });
        }

        function handleCertificateButton(assessment, container) {
            container.innerHTML = '<span><i class="fas fa-spinner fa-spin"></i> Checking certificate status...</span>';
            const userId = userData.user_id;
            const moduleAssessmentId = assessment.module_assessment_id;

            fetch(`http://127.0.0.1:8000/api/v1/users/${userId}/certificates`)
                .then(response => response.json())
                .then(certData => {
                    const existingCert = certData.data && certData.data.find(cert => cert.module_assessment_id === moduleAssessmentId);
                    
                    if (existingCert) {
                        container.innerHTML = `<button class="btn btn-info"><i class="fas fa-certificate me-2"></i>View Certificate</button>`;
                        container.querySelector('button').addEventListener('click', () => {
                            openCertificateWindow(assessment);
                        });
                    } else {
                        container.innerHTML = `<button class="btn btn-primary"><i class="fas fa-award me-2"></i>Get Certificate</button>`;
                        container.querySelector('button').addEventListener('click', () => {
                            createCertificate(assessment, container);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error checking for certificate:', error);
                    container.innerHTML = '<span class="text-danger">Could not check certificate status.</span>';
                });
        }

        function createCertificate(assessment, container) {
            container.innerHTML = `<span><i class="fas fa-spinner fa-spin"></i> Generating certificate...</span>`;

            const payload = {
                user_id: userData.user_id,
                module_assessment_id: assessment.module_assessment_id,
                course_id: assessment.assessment.course_id
            };

            fetch('http://127.0.0.1:8000/api/v1/certificates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to create certificate record.');
                }
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    return response.json();
                } else {
                    return null; // Don't try to parse if not JSON
                }
            })
            .then(newCert => {
                container.innerHTML = `<button class="btn btn-info"><i class="fas fa-certificate me-2"></i>View Certificate</button>`;
                container.querySelector('button').addEventListener('click', () => {
                    openCertificateWindow(assessment);
                });
                openCertificateWindow(assessment);
            })
            .catch(error => {
                console.error('Error creating certificate:', error);
                container.innerHTML = '<span class="text-danger">Could not generate certificate. Please try again.</span>';
                const button = document.createElement('button');
                button.className = 'btn btn-primary mt-2';
                button.innerHTML = '<i class="fas fa-award me-2"></i>Retry</button>';
                button.onclick = () => createCertificate(assessment, container);
                container.append(button);
            });
        }

        function openCertificateWindow(assessment) {
            const studentName = `${userData.first_name} ${userData.last_name}`;
            const assessmentTitle = assessment.assessment.assessment_title;
            const moduleNumber = assessment.assessment.module_number;
            const url = `certificate.html?studentName=${encodeURIComponent(studentName)}&assessmentTitle=${encodeURIComponent(assessmentTitle)}&moduleNumber=${encodeURIComponent(moduleNumber)}`;
            window.open(url, '_blank');
        }

        function getPreviousAssessment() {
          const currentIndex = allAssessments.findIndex(a => a.assessment_progress_id === currentAssessment.assessment_progress_id);
          return currentIndex > 0 ? allAssessments[currentIndex - 1] : null;
        }

        function getNextAssessment() {
          const currentIndex = allAssessments.findIndex(a => a.assessment_progress_id === currentAssessment.assessment_progress_id);
          return currentIndex < allAssessments.length - 1 ? allAssessments[currentIndex + 1] : null;
        }

        function navigateAssessment(direction) {
          const nextAssessment = direction === 'next' ? getNextAssessment() : getPreviousAssessment();
          if (nextAssessment) {
            currentAssessment = nextAssessment;
            displayCurrentAssessment();
          }
        }

        function updateNavigationButtons() {
          const prevAssessment = getPreviousAssessment();
          const nextAssessment = getNextAssessment();

          $('.btn-back').prop('disabled', !prevAssessment);
          $('.btn-continue').prop('disabled', !nextAssessment);
        }

        // Update buildModuleList to handle assessment selection
        function buildModuleList(assessments) {
          const moduleList = $("#module-list");
          moduleList.empty();

          // Group assessments by module
          const moduleGroups = assessments.reduce((groups, assessment) => {
            const moduleNumber = assessment.assessment.module_number;
            if (!groups[moduleNumber]) {
              groups[moduleNumber] = [];
            }
            groups[moduleNumber].push(assessment);
            return groups;
          }, {});

          // Find the first incomplete module number
          let firstIncompleteModule = Object.entries(moduleGroups).find(([moduleNumber, assessments]) => {
            return assessments.some(a => a.status !== "completed");
          })?.[0];

          firstIncompleteModule = firstIncompleteModule ? parseInt(firstIncompleteModule) : null;

          // Create module items
          Object.entries(moduleGroups).forEach(([moduleNumber, moduleAssessments]) => {
            const moduleNum = parseInt(moduleNumber);
            const completedCount = moduleAssessments.filter(a => a.status === "completed").length;
            const isCompleted = completedCount === moduleAssessments.length;
            const isInProgress = !isCompleted && moduleAssessments.some(a => a.status === "in_progress");
            const isLocked = firstIncompleteModule !== null && moduleNum > firstIncompleteModule;

            const moduleItem = $(`
              <li class="module-item">
                <div class="module-header ${isCompleted ? 'completed' : isInProgress ? 'active' : ''} ${isLocked ? 'locked' : ''}">
                  <i class="fas ${isCompleted ? 'fa-check-circle' : isLocked ? 'fa-lock' : 'fa-book'}"></i>
                  <span>Module ${moduleNumber} Assessments</span>
                  <i class="fas fa-chevron-down ms-auto"></i>
                  ${isCompleted ? '<span class="badge bg-success">Completed</span>' : ''}
                  ${isLocked ? '<span class="badge bg-secondary">Locked</span>' : ''}
                </div>
                <ul class="assessment-list" style="display: none;">
                  ${moduleAssessments.map(assessment => {
                    const isAssessmentCompleted = assessment.status === "completed";
                    const isModuleLocked = !assessment.module_progress?.status || assessment.module_progress.status !== 'completed';
                    const shouldDisable = !isAssessmentCompleted && isModuleLocked;
                    
                    return `
                      <li class="assessment-item p-2 ${isAssessmentCompleted ? 'text-success' : ''} 
                          ${assessment.assessment_progress_id === currentAssessment?.assessment_progress_id ? 'active' : ''} 
                          ${shouldDisable ? 'disabled' : ''}" 
                          data-assessment-id="${assessment.assessment_progress_id}">
                        <i class="fas ${isAssessmentCompleted ? 'fa-check-circle' : shouldDisable ? 'fa-lock' : 'fa-file-alt'} me-2"></i>
                        ${assessment.assessment.assessment_title}
                        ${isAssessmentCompleted && assessment.file_url ? 
                          '<i class="fas fa-paperclip ms-2" title="Has submission"></i>' : ''}
                        ${!isAssessmentCompleted && isModuleLocked ? 
                          '<span class="badge bg-warning ms-2">Complete module first</span>' : ''}
                      </li>
                    `;
                  }).join('')}
                </ul>
              </li>
            `);

            moduleList.append(moduleItem);
          });

          // Add click handlers for module headers
          $(".module-header").click(function() {
            if ($(this).hasClass('locked')) {
              return;
            }
            $(this).find(".fa-chevron-down").toggleClass("fa-chevron-up");
            $(this).siblings(".assessment-list").slideToggle();
          });

          // Add click handlers for assessment items
          $(".assessment-item").click(function() {
            // Allow clicking if completed or if module is completed
            const assessmentId = $(this).data("assessment-id");
            const selectedAssessment = allAssessments.find(a => a.assessment_progress_id === assessmentId);
            
            if (selectedAssessment && (selectedAssessment.status === "completed" || 
                (selectedAssessment.module_progress?.status === "completed"))) {
              currentAssessment = selectedAssessment;
              displayCurrentAssessment();
            } else if ($(this).hasClass('disabled')) {
              return;
            }
          });
        }

        function updateProgressIndicator(assessments) {
          const totalAssessments = assessments.length;
          const completedAssessments = assessments.filter(a => a.status === "completed").length;
          const progressPercentage = Math.round((completedAssessments / totalAssessments) * 100);

          $(".progress-bar").css("width", `${progressPercentage}%`);
          $(".progress-bar").attr("aria-valuenow", progressPercentage);
          $(".progress-text").text(`${progressPercentage}%`);
        }

        // Cloudinary configuration
        const CLOUDINARY_CONFIG = {
          cloudName: 'dwn5t3o4j',
          apiKey: '214461813776441',
          apiSecret: '-3Lake60UIDCJSt7eugmk_-CRIM',
          uploadPreset: 'ml_default'
        };

        // Updated handleFile function to support all file types
        function handleFile(file) {
          if (!file) return;

          const preview = document.querySelector('.file-upload-preview');
          const fileTypeIcon = preview.querySelector('.file-type-icon i');
          const submitBtn = document.getElementById('uploadSubmitBtn');

          // Enable submit button
          submitBtn.disabled = false;

          // Show file details
          document.getElementById('fileName').textContent = file.name;
          document.getElementById('fileSize').textContent = formatFileSize(file.size);
          document.getElementById('fileType').textContent = file.type || 'Unknown type';

          // Set appropriate icon based on file type
          fileTypeIcon.className = getFileIcon(file.type);

          // Show preview
          preview.style.display = 'block';
        }

        // Helper function to format file size
        function formatFileSize(bytes) {
          if (bytes === 0) return '0 Bytes';
          const k = 1024;
          const sizes = ['Bytes', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Helper function to get appropriate file icon
        function getFileIcon(mimeType) {
          if (!mimeType) return 'fas fa-file';
          
          if (mimeType.startsWith('image/')) return 'fas fa-file-image';
          if (mimeType.startsWith('video/')) return 'fas fa-file-video';
          if (mimeType.startsWith('audio/')) return 'fas fa-file-audio';
          if (mimeType.startsWith('text/')) return 'fas fa-file-alt';
          if (mimeType.includes('pdf')) return 'fas fa-file-pdf';
          if (mimeType.includes('word') || mimeType.includes('document')) return 'fas fa-file-word';
          if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'fas fa-file-excel';
          if (mimeType.includes('powerpoint') || mimeType.includes('presentation')) return 'fas fa-file-powerpoint';
          if (mimeType.includes('zip') || mimeType.includes('archive')) return 'fas fa-file-archive';
          
          return 'fas fa-file';
        }

        // Update uploadToCloudinary function to show progress
        async function uploadToCloudinary(file) {
          const formData = new FormData();
          const timestamp = Math.round((new Date).getTime()/1000);
          const uploadFolder = 'assessment_submissions';

          formData.append('file', file);
          formData.append('folder', uploadFolder);
          formData.append('timestamp', timestamp);
          
          const signatureStr = `folder=${uploadFolder}&timestamp=${timestamp}${CLOUDINARY_CONFIG.apiSecret}`;
          const signature = CryptoJS.SHA1(signatureStr).toString();
          
          formData.append('signature', signature);
          formData.append('api_key', CLOUDINARY_CONFIG.apiKey);

          const progressBar = document.querySelector('.file-upload-progress');
          const progressBarInner = progressBar.querySelector('.progress-bar');
          const uploadStatus = document.getElementById('uploadStatus');
          
          progressBar.style.display = 'block';

          try {
            const xhr = new XMLHttpRequest();
            
            // Create promise to handle upload
            const uploadPromise = new Promise((resolve, reject) => {
              xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                  const percentComplete = Math.round((e.loaded / e.total) * 100);
                  progressBarInner.style.width = percentComplete + '%';
                  progressBarInner.setAttribute('aria-valuenow', percentComplete);
                  uploadStatus.textContent = `Uploading... ${percentComplete}%`;
                }
              };

              xhr.onload = () => {
                if (xhr.status === 200) {
                  const response = JSON.parse(xhr.responseText);
                  uploadStatus.textContent = 'Upload complete!';
                  progressBarInner.classList.add('bg-success');
                  resolve(response.secure_url);
                } else {
                  reject(new Error('Upload failed'));
                }
              };

              xhr.onerror = () => reject(new Error('Upload failed'));
            });

            xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/auto/upload`);
            xhr.send(formData);

            return await uploadPromise;
          } catch (error) {
            uploadStatus.textContent = 'Upload failed';
            progressBarInner.classList.add('bg-danger');
            throw error;
          }
        }

        // Add back the completeAssessment function
        window.completeAssessment = function(assessmentProgressId) {
          const assessment = allAssessments.find(a => a.assessment_progress_id === assessmentProgressId);
          
          // Check if module is completed
          if (!assessment.module_progress?.status || assessment.module_progress.status !== 'completed') {
            alert('You must complete the module before submitting the assessment.');
            return;
          }

          // Show file upload modal
          const modal = new bootstrap.Modal(document.getElementById('fileUploadModal'));
          modal.show();

          // Handle file upload and assessment completion
          document.getElementById('uploadSubmitBtn').onclick = async function() {
            const fileInput = document.getElementById('fileUpload');
            const file = fileInput.files[0];

            if (!file) {
              alert('Please select a file to upload');
              return;
            }

            // Show loading overlay
            const loadingOverlay = document.getElementById("loadingOverlay");
            const loadingText = document.getElementById("loadingText");
            loadingText.textContent = "Uploading file and updating assessment status...";
            loadingOverlay.classList.add("active");

            try {
              // Delete existing scores before submitting new work
              const scoresRes = await fetch(`http://127.0.0.1:8000/api/v1/scores/assessment-progress/${assessmentProgressId}`);
              if (scoresRes.ok) {
                  const scoresData = await scoresRes.json();
                  if (scoresData && scoresData.data && scoresData.data.length > 0) {
                      for (const score of scoresData.data) {
                          await fetch(`http://127.0.0.1:8000/api/v1/scores/${score.score_id}`, { method: 'DELETE' });
                      }
                  }
              }

              // Delete existing feedback
              const feedbackRes = await fetch(`http://127.0.0.1:8000/api/v1/feedback/assessment-progress/${assessmentProgressId}`);
              if (feedbackRes.ok) {
                  const feedbackData = await feedbackRes.json();
                  if (feedbackData && feedbackData.data && feedbackData.data.length > 0) {
                      for (const feedback of feedbackData.data) {
                          await fetch(`http://127.0.0.1:8000/api/v1/feedback/${feedback.feedback_id}`, { method: 'DELETE' });
                      }
                  }
              }
              
              // Upload file to Cloudinary
              const fileUrl = await uploadToCloudinary(file);

              // Update the assessment status to completed with the file URL
              const response = await fetch(`http://127.0.0.1:8000/api/v1/module-assessment-progress/${assessmentProgressId}`, {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  status: 'completed',
                  file_url: fileUrl
                })
              });

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

              const data = await response.json();
              console.log("Assessment completed successfully:", data);
              
              // Update the current assessment status
              currentAssessment.status = "completed";
              
              // Get the next assessment
              const nextAssessment = getNextAssessment();
              
              // Refresh the module list and progress indicator
              buildModuleList(allAssessments);
              updateProgressIndicator(allAssessments);

              // Hide modals
              modal.hide();
              loadingOverlay.classList.remove("active");

              // If there's a next assessment, navigate to it
              if (nextAssessment) {
                currentAssessment = nextAssessment;
                displayCurrentAssessment();
              } else {
                // If no next assessment, show completion message
                const container = $("#assessment-container");
                container.html(`
                  <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    Congratulations! You have completed all assessments.
                  </div>
                `);
              }
            } catch (error) {
              console.error("Error completing assessment:", error);
              loadingText.textContent = "Error updating assessment status. Please try again.";
              setTimeout(() => {
                loadingOverlay.classList.remove("active");
              }, 1000);
              alert('Error uploading file: ' + error.message);
            }
          };
        };

        // Update drag and drop event listeners
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileUpload');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
          dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
          dropZone.classList.add('drag-over');
        }

        function unhighlight(e) {
          dropZone.classList.remove('drag-over');
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
          const dt = e.dataTransfer;
          const file = dt.files[0];
          handleFile(file);
        }

        fileInput.addEventListener('change', function(e) {
          handleFile(this.files[0]);
        });

        // Reset file upload form when modal is hidden
        document.getElementById('fileUploadModal').addEventListener('hidden.bs.modal', function () {
          const preview = document.querySelector('.file-upload-preview');
          const progress = document.querySelector('.file-upload-progress');
          const progressBar = progress.querySelector('.progress-bar');
          const uploadStatus = document.getElementById('uploadStatus');
          const submitBtn = document.getElementById('uploadSubmitBtn');
          
          preview.style.display = 'none';
          progress.style.display = 'none';
          progressBar.style.width = '0%';
          progressBar.classList.remove('bg-success', 'bg-danger');
          uploadStatus.textContent = 'Uploading...';
          submitBtn.disabled = true;
          fileInput.value = '';
        });

        // Add click handler for browse button
        document.getElementById('browseButton').addEventListener('click', function(e) {
          e.preventDefault(); // Prevent form submission
          document.getElementById('fileUpload').click();
        });

        // Initialize the page
        console.log("Page initialized with user:", userData);
      });
    </script>
  </body>
</html> 