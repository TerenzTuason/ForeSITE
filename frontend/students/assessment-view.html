<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assessment Progress - ForeSITE</title>
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      :root {
        --maroon: #800000;
        --gold: #ffb81c;
        --light-gray: #f5f5f5;
        --dark-gray: #333;
        --border-radius: 8px;
        --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        --sidebar-width: 320px;
      }

      body {
        font-family: "Poppins", sans-serif;
        background-color: var(--light-gray);
        min-height: 100vh;
        overflow-x: hidden;
      }

      .navbar {
        background: var(--maroon);
        padding: 1rem 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 1030;
      }

      .navbar-brand {
        color: white !important;
        font-weight: 600;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .navbar-brand img {
        height: 35px;
      }

      .assessment-container {
        display: flex;
        margin-top: 56px;
      }

      .sidebar {
        width: var(--sidebar-width);
        background: white;
        height: calc(100vh - 56px);
        position: fixed;
        left: 0;
        overflow-y: auto;
        padding: 1.5rem;
        border-right: 1px solid #eee;
      }

      .main-content {
        margin-left: var(--sidebar-width);
        flex: 1;
        padding: 2rem;
        min-height: calc(100vh - 56px);
      }

      .module-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .module-item {
        margin-bottom: 1rem;
        border: 1px solid #eee;
        border-radius: var(--border-radius);
        overflow: hidden;
      }

      .module-header {
        padding: 1rem;
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .module-header:not(.locked):hover {
        background-color: #e9ecef;
        cursor: pointer;
      }

      .module-header.locked:hover {
        cursor: not-allowed;
      }

      .module-header.active {
        background: var(--maroon);
        color: white;
      }

      .module-header.completed {
        background: #d4edda;
        color: #155724;
        border-color: #c3e6cb;
      }

      .progress-indicator {
        margin-top: 2.5rem;
        margin-bottom: 2rem;
      }

      .progress {
        height: 0.5rem;
        background-color: #e9ecef;
        margin-top: 0.5rem;
      }

      .progress-bar {
        background-color: var(--maroon);
        border-radius: 4px;
      }

      .assessment-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
        overflow: hidden;
      }

      .assessment-header {
        padding: 1.5rem;
        border-bottom: 1px solid #eee;
        background: #f8f9fa;
      }

      .assessment-title {
        margin: 0;
        color: var(--maroon);
        font-size: 1.25rem;
        font-weight: 600;
      }

      .assessment-module {
        color: var(--dark-gray);
        font-size: 0.9rem;
        margin-top: 0.5rem;
      }

      .assessment-body {
        padding: 1.5rem;
      }

      .assessment-objective {
        color: var(--dark-gray);
        margin-bottom: 1.5rem;
      }

      .assessment-scenario {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: var(--border-radius);
        margin-bottom: 1.5rem;
      }

      .assessment-steps {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .assessment-step {
        padding: 1rem;
        border: 1px solid #eee;
        border-radius: var(--border-radius);
        margin-bottom: 1rem;
      }

      .step-title {
        font-weight: 600;
        color: var(--maroon);
        margin-bottom: 0.5rem;
      }

      .step-description {
        color: var(--dark-gray);
        white-space: pre-line;
      }

      .assessment-footer {
        padding: 1.5rem;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .status-badge {
        padding: 0.5rem 1rem;
        border-radius: var(--border-radius);
        font-size: 0.9rem;
        font-weight: 500;
      }

      .status-not-started {
        background-color: #f8f9fa;
        color: var(--dark-gray);
      }

      .status-in-progress {
        background-color: var(--gold);
        color: var(--dark-gray);
      }

      .status-completed {
        background-color: #28a745;
        color: white;
      }

      .btn-start-assessment {
        background: linear-gradient(to right, var(--maroon), #600000);
        color: white;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: var(--border-radius);
        font-weight: 500;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(128, 0, 0, 0.2);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-start-assessment:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(128, 0, 0, 0.3);
        color: white;
      }

      .btn-start-assessment[disabled] {
        opacity: 0.65;
        cursor: not-allowed;
        transform: none;
      }

      .btn-complete-assessment {
        background: linear-gradient(to right, var(--maroon), #600000);
        color: white;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: var(--border-radius);
        font-weight: 500;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(128, 0, 0, 0.2);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-complete-assessment:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(128, 0, 0, 0.3);
        color: white;
      }

      .btn-complete-assessment[disabled] {
        opacity: 0.65;
        cursor: not-allowed;
        transform: none;
      }

      /* Loading screen styles */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        color: white;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }

      .loading-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .loading-spinner {
        width: 80px;
        height: 80px;
        border: 8px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--gold);
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        font-size: 1.2rem;
        font-weight: 500;
        text-align: center;
        max-width: 80%;
        line-height: 1.6;
      }

      @media (max-width: 992px) {
        .sidebar {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
          z-index: 1020;
        }

        .sidebar.show {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }

        .toggle-sidebar {
          display: block;
        }
      }

      .content-footer {
        padding: 1.5rem;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .nav-button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        font-weight: 500;
      }

      .btn-back {
        background-color: #f8f9fa;
        color: var(--dark-gray);
      }

      .btn-back:hover {
        background-color: #e9ecef;
      }

      .btn-back[disabled] {
        opacity: 0.65;
        cursor: not-allowed;
      }

      .btn-continue {
        background: linear-gradient(to right, var(--maroon), #600000);
        color: white;
        box-shadow: 0 4px 15px rgba(128, 0, 0, 0.2);
      }

      .btn-continue:hover {
        background: linear-gradient(to right, #600000, #400000);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(128, 0, 0, 0.3);
      }

      .btn-continue[disabled] {
        opacity: 0.65;
        cursor: not-allowed;
        transform: none;
      }

      .module-header.locked {
        background-color: #f8f9fa;
        color: #6c757d;
        cursor: not-allowed;
      }

      .module-header.locked .badge {
        background-color: #6c757d;
      }

      .assessment-item {
        transition: all 0.2s ease;
      }

      .assessment-item:not(.disabled):hover {
        background-color: #f8f9fa;
        cursor: pointer;
      }

      .assessment-item.disabled:hover {
        cursor: not-allowed;
      }

      .assessment-item.active {
        background-color: #f8f9fa;
        color: var(--maroon);
        border-left: 3px solid var(--maroon);
      }

      .assessment-item.completed:hover {
        cursor: pointer;
      }

      .assessment-item.completed i {
        color: #28a745;
      }

      .spacer {
        flex: 1;
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <div id="navbar-placeholder"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loadingText">
        Loading your assessment progress...
      </div>
    </div>

    <div class="assessment-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="progress-indicator">
          <div class="d-flex justify-content-between align-items-center">
            <span>Assessment Progress</span>
            <span class="progress-text">0%</span>
          </div>
          <div class="progress">
            <div
              class="progress-bar"
              role="progressbar"
              style="width: 0%"
              aria-valuenow="0"
              aria-valuemin="0"
              aria-valuemax="100"
            ></div>
          </div>
        </div>

        <ul class="module-list" id="module-list">
          <!-- Modules will be loaded here dynamically -->
        </ul>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="container-fluid">
          <div id="assessment-container">
            <!-- Current assessment will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $(document).ready(function () {
        // Load navbar
        $("#navbar-placeholder").load("../components/navbar.html");

        // Get user data from session storage
        const userData = JSON.parse(sessionStorage.getItem("user"));
        if (!userData) {
          window.location.href = "../login.html";
          return;
        }

        let currentAssessment = null;
        let allAssessments = [];

        // Show loading overlay
        const loadingOverlay = document.getElementById("loadingOverlay");
        const loadingText = document.getElementById("loadingText");
        loadingOverlay.classList.add("active");

        // Fetch assessment progress
        fetchAssessmentProgress(userData.user_id);

        function fetchAssessmentProgress(userId) {
          console.log("Fetching assessment progress for user:", userId);
          
          fetch(`http://127.0.0.1:8000/api/v1/users/${userId}/assessment-progress`)
            .then((response) => {
              console.log("Response received:", response);
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then((data) => {
              console.log("Assessment data received:", data);
              
              if (!data || !data.data || !Array.isArray(data.data)) {
                throw new Error("Invalid data format received");
              }

              allAssessments = data.data;
              
              if (allAssessments.length === 0) {
                // Handle no assessments case
                const container = $("#assessment-container");
                container.html(`
                  <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    No assessments are available at this time.
                  </div>
                `);
                loadingOverlay.classList.remove("active");
                return;
              }

              buildModuleList(allAssessments);
              updateProgressIndicator(allAssessments);

              // Find the first incomplete assessment or first assessment if all completed
              currentAssessment = allAssessments.find(a => a.status !== "completed") || allAssessments[0];
              
              if (currentAssessment) {
                console.log("Setting current assessment:", currentAssessment);
                displayCurrentAssessment();
              }

              // Hide loading overlay
              setTimeout(() => {
                loadingOverlay.classList.remove("active");
              }, 500);
            })
            .catch((error) => {
              console.error("Error loading assessment progress:", error);
              
              // Show error message in the main container
              const container = $("#assessment-container");
              container.html(`
                <div class="alert alert-danger">
                  <i class="fas fa-exclamation-circle"></i>
                  Error loading assessment progress. Please try refreshing the page.
                  <br>
                  <small class="text-muted">${error.message}</small>
                </div>
              `);

              loadingText.textContent = "Error loading assessment progress. Please try again later.";
              setTimeout(() => {
                loadingOverlay.classList.remove("active");
              }, 1000);
            });
        }

        function displayCurrentAssessment() {
          if (!currentAssessment) return;

          // Scroll to top of the page
          window.scrollTo(0, 0);
          // Also scroll the main content area to top
          $(".main-content").scrollTop(0);

          const container = $("#assessment-container");
          container.empty();

          const card = createAssessmentCard(currentAssessment);
          container.append(card);

          // Update sidebar active state
          $(".assessment-item").removeClass("active");
          $(`.assessment-item[data-assessment-id="${currentAssessment.assessment_progress_id}"]`).addClass("active");

          // Expand the current module in sidebar
          const currentModuleHeader = $(`.assessment-item[data-assessment-id="${currentAssessment.assessment_progress_id}"]`)
            .closest(".module-item")
            .find(".module-header");
          
          currentModuleHeader.siblings(".assessment-list").slideDown();
          currentModuleHeader.find(".fa-chevron-down").addClass("fa-chevron-up");

          updateNavigationButtons();
        }

        function createAssessmentCard(assessment) {
          const card = $(`
            <div class="assessment-card" data-assessment-id="${assessment.assessment_progress_id}">
              <div class="assessment-header">
                <h3 class="assessment-title">${assessment.assessment.assessment_title}</h3>
                <div class="assessment-module">Module ${assessment.assessment.module_number}</div>
              </div>
              <div class="assessment-body">
                ${assessment.assessment.assessment_objective
                  ? `<div class="assessment-objective">
                       <strong>Objective:</strong> ${assessment.assessment.assessment_objective}
                     </div>`
                  : ""}
                ${assessment.assessment.assessment_scenario
                  ? `<div class="assessment-scenario">
                       <strong>Scenario:</strong><br>
                       ${assessment.assessment.assessment_scenario}
                     </div>`
                  : ""}
                <div class="assessment-steps">
                  <h4 class="mb-3">Assessment Steps:</h4>
                  ${assessment.assessment.assessment_instructions
                    .map(
                      (step) => `
                    <div class="assessment-step">
                      <div class="step-title">${step.step_title}</div>
                      <div class="step-description">${step.step_description}</div>
                    </div>
                  `
                    )
                    .join("")}
                </div>
              </div>
              <div class="content-footer">
                <button class="nav-button btn-back" ${getPreviousAssessment() ? '' : 'disabled'}>
                  <i class="fas fa-arrow-left"></i> Back
                </button>
                <div class="spacer"></div>
                <button class="btn-complete-assessment" onclick="completeAssessment(${assessment.assessment_progress_id})" 
                  ${assessment.status === "completed" ? "disabled" : ""}>
                  ${assessment.status === "completed" 
                    ? '<i class="fas fa-check"></i> Completed'
                    : '<i class="fas fa-check"></i> Complete Assessment'}
                </button>
              </div>
            </div>
          `);

          // Add navigation button handlers
          card.find('.btn-back').click(() => navigateAssessment('prev'));
          card.find('.btn-continue').click(() => navigateAssessment('next'));

          return card;
        }

        function getPreviousAssessment() {
          const currentIndex = allAssessments.findIndex(a => a.assessment_progress_id === currentAssessment.assessment_progress_id);
          return currentIndex > 0 ? allAssessments[currentIndex - 1] : null;
        }

        function getNextAssessment() {
          const currentIndex = allAssessments.findIndex(a => a.assessment_progress_id === currentAssessment.assessment_progress_id);
          return currentIndex < allAssessments.length - 1 ? allAssessments[currentIndex + 1] : null;
        }

        function navigateAssessment(direction) {
          const nextAssessment = direction === 'next' ? getNextAssessment() : getPreviousAssessment();
          if (nextAssessment) {
            currentAssessment = nextAssessment;
            displayCurrentAssessment();
          }
        }

        function updateNavigationButtons() {
          const prevAssessment = getPreviousAssessment();
          const nextAssessment = getNextAssessment();

          $('.btn-back').prop('disabled', !prevAssessment);
          $('.btn-continue').prop('disabled', !nextAssessment);
        }

        // Update buildModuleList to handle assessment selection
        function buildModuleList(assessments) {
          const moduleList = $("#module-list");
          moduleList.empty();

          // Group assessments by module
          const moduleGroups = assessments.reduce((groups, assessment) => {
            const moduleNumber = assessment.assessment.module_number;
            if (!groups[moduleNumber]) {
              groups[moduleNumber] = [];
            }
            groups[moduleNumber].push(assessment);
            return groups;
          }, {});

          // Find the first incomplete module number
          let firstIncompleteModule = Object.entries(moduleGroups).find(([moduleNumber, assessments]) => {
            return assessments.some(a => a.status !== "completed");
          })?.[0];

          firstIncompleteModule = firstIncompleteModule ? parseInt(firstIncompleteModule) : null;

          // Create module items
          Object.entries(moduleGroups).forEach(([moduleNumber, moduleAssessments]) => {
            const moduleNum = parseInt(moduleNumber);
            const completedCount = moduleAssessments.filter(a => a.status === "completed").length;
            const isCompleted = completedCount === moduleAssessments.length;
            const isInProgress = !isCompleted && moduleAssessments.some(a => a.status === "in_progress");
            const isLocked = firstIncompleteModule !== null && moduleNum > firstIncompleteModule;

            const moduleItem = $(`
              <li class="module-item">
                <div class="module-header ${isCompleted ? 'completed' : isInProgress ? 'active' : ''} ${isLocked ? 'locked' : ''}">
                  <i class="fas ${isCompleted ? 'fa-check-circle' : isLocked ? 'fa-lock' : 'fa-book'}"></i>
                  <span>Module ${moduleNumber} Assessments</span>
                  <i class="fas fa-chevron-down ms-auto"></i>
                  ${isCompleted ? '<span class="badge bg-success">Completed</span>' : ''}
                  ${isLocked ? '<span class="badge bg-secondary">Locked</span>' : ''}
                </div>
                <ul class="assessment-list" style="display: none;">
                  ${moduleAssessments.map(assessment => `
                    <li class="assessment-item p-2 ${assessment.status === 'completed' ? 'text-success' : ''} 
                        ${assessment.assessment_progress_id === currentAssessment?.assessment_progress_id ? 'active' : ''} 
                        ${isLocked ? 'disabled' : ''}" 
                        data-assessment-id="${assessment.assessment_progress_id}">
                      <i class="fas ${assessment.status === 'completed' ? 'fa-check-circle' : 'fa-file-alt'} me-2"></i>
                      ${assessment.assessment.assessment_title}
                    </li>
                  `).join('')}
                </ul>
              </li>
            `);

            moduleList.append(moduleItem);
          });

          // Add click handlers for module headers
          $(".module-header").click(function() {
            if ($(this).hasClass('locked')) {
              return;
            }
            $(this).find(".fa-chevron-down").toggleClass("fa-chevron-up");
            $(this).siblings(".assessment-list").slideToggle();
          });

          // Add click handlers for assessment items
          $(".assessment-item").click(function() {
            if ($(this).hasClass('disabled')) {
              return;
            }
            const assessmentId = $(this).data("assessment-id");
            const selectedAssessment = allAssessments.find(a => a.assessment_progress_id === assessmentId);
            if (selectedAssessment) {
              currentAssessment = selectedAssessment;
              displayCurrentAssessment();
            }
          });
        }

        function updateProgressIndicator(assessments) {
          const totalAssessments = assessments.length;
          const completedAssessments = assessments.filter(a => a.status === "completed").length;
          const progressPercentage = Math.round((completedAssessments / totalAssessments) * 100);

          $(".progress-bar").css("width", `${progressPercentage}%`);
          $(".progress-bar").attr("aria-valuenow", progressPercentage);
          $(".progress-text").text(`${progressPercentage}%`);
        }

        // Add to global scope for button click handler
        window.completeAssessment = function (assessmentProgressId) {
          // Show loading overlay
          const loadingOverlay = document.getElementById("loadingOverlay");
          const loadingText = document.getElementById("loadingText");
          loadingText.textContent = "Updating assessment status...";
          loadingOverlay.classList.add("active");

          // Scroll to top of the page
          window.scrollTo(0, 0);
          // Also scroll the main content area to top
          $(".main-content").scrollTop(0);

          // Update the assessment status to completed
          fetch(`http://127.0.0.1:8000/api/v1/module-assessment-progress/${assessmentProgressId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              status: 'completed'
            })
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log("Assessment completed successfully:", data);
            
            // Update the current assessment status
            currentAssessment.status = "completed";
            
            // Get the next assessment
            const nextAssessment = getNextAssessment();
            
            // Refresh the module list and progress indicator
            buildModuleList(allAssessments);
            updateProgressIndicator(allAssessments);

            // Hide loading overlay
            loadingOverlay.classList.remove("active");

            // If there's a next assessment, navigate to it
            if (nextAssessment) {
              // Update current assessment
              currentAssessment = nextAssessment;
              
              // Display the next assessment
              displayCurrentAssessment();

              // Find and expand the module containing the next assessment
              const nextModuleNumber = nextAssessment.assessment.module_number;
              const moduleHeader = $(`#module-${nextModuleNumber} .module-header`);
              
              // Show the assessment list if it's hidden
              moduleHeader.siblings(".assessment-list").slideDown();
              moduleHeader.find(".fa-chevron-down").addClass("fa-chevron-up");
            } else {
              // If no next assessment, show completion message
              const container = $("#assessment-container");
              container.html(`
                <div class="alert alert-success">
                  <i class="fas fa-check-circle"></i>
                  Congratulations! You have completed all assessments.
                </div>
              `);
            }
          })
          .catch(error => {
            console.error("Error completing assessment:", error);
            loadingText.textContent = "Error updating assessment status. Please try again.";
            setTimeout(() => {
              loadingOverlay.classList.remove("active");
            }, 1000);
          });
        };

        // Initialize the page
        console.log("Page initialized with user:", userData);
      });
    </script>
  </body>
</html> 