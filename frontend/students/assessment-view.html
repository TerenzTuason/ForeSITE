<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assessment Progress - ForeSITE</title>
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      :root {
        --maroon: #800000;
        --gold: #ffb81c;
        --light-gray: #f5f5f5;
        --dark-gray: #333;
        --border-radius: 8px;
        --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        --sidebar-width: 320px;
      }

      body {
        font-family: "Poppins", sans-serif;
        background-color: var(--light-gray);
        min-height: 100vh;
        overflow-x: hidden;
      }

      .navbar {
        background: var(--maroon);
        padding: 1rem 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 1030;
      }

      .navbar-brand {
        color: white !important;
        font-weight: 600;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .navbar-brand img {
        height: 35px;
      }

      .assessment-container {
        display: flex;
        margin-top: 56px;
      }

      .sidebar {
        width: var(--sidebar-width);
        background: white;
        height: calc(100vh - 56px);
        position: fixed;
        left: 0;
        overflow-y: auto;
        padding: 1.5rem;
        border-right: 1px solid #eee;
      }

      .main-content {
        margin-left: var(--sidebar-width);
        flex: 1;
        padding: 2rem;
        min-height: calc(100vh - 56px);
      }

      .module-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .module-item {
        margin-bottom: 1rem;
        border: 1px solid #eee;
        border-radius: var(--border-radius);
        overflow: hidden;
      }

      .module-header {
        padding: 1rem;
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .module-header.active {
        background: var(--maroon);
        color: white;
      }

      .module-header.completed {
        background: #d4edda;
        color: #155724;
        border-color: #c3e6cb;
      }

      .progress-indicator {
        margin-top: 2.5rem;
        margin-bottom: 2rem;
      }

      .progress {
        height: 0.5rem;
        background-color: #e9ecef;
        margin-top: 0.5rem;
      }

      .progress-bar {
        background-color: var(--maroon);
        border-radius: 4px;
      }

      .assessment-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
        overflow: hidden;
      }

      .assessment-header {
        padding: 1.5rem;
        border-bottom: 1px solid #eee;
        background: #f8f9fa;
      }

      .assessment-title {
        margin: 0;
        color: var(--maroon);
        font-size: 1.25rem;
        font-weight: 600;
      }

      .assessment-module {
        color: var(--dark-gray);
        font-size: 0.9rem;
        margin-top: 0.5rem;
      }

      .assessment-body {
        padding: 1.5rem;
      }

      .assessment-objective {
        color: var(--dark-gray);
        margin-bottom: 1.5rem;
      }

      .assessment-scenario {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: var(--border-radius);
        margin-bottom: 1.5rem;
      }

      .assessment-steps {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .assessment-step {
        padding: 1rem;
        border: 1px solid #eee;
        border-radius: var(--border-radius);
        margin-bottom: 1rem;
      }

      .step-title {
        font-weight: 600;
        color: var(--maroon);
        margin-bottom: 0.5rem;
      }

      .step-description {
        color: var(--dark-gray);
        white-space: pre-line;
      }

      .assessment-footer {
        padding: 1.5rem;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .status-badge {
        padding: 0.5rem 1rem;
        border-radius: var(--border-radius);
        font-size: 0.9rem;
        font-weight: 500;
      }

      .status-not-started {
        background-color: #f8f9fa;
        color: var(--dark-gray);
      }

      .status-in-progress {
        background-color: var(--gold);
        color: var(--dark-gray);
      }

      .status-completed {
        background-color: #28a745;
        color: white;
      }

      .btn-start-assessment {
        background: linear-gradient(to right, var(--maroon), #600000);
        color: white;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: var(--border-radius);
        font-weight: 500;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(128, 0, 0, 0.2);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-start-assessment:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(128, 0, 0, 0.3);
        color: white;
      }

      .btn-start-assessment[disabled] {
        opacity: 0.65;
        cursor: not-allowed;
        transform: none;
      }

      /* Loading screen styles */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        color: white;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }

      .loading-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .loading-spinner {
        width: 80px;
        height: 80px;
        border: 8px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--gold);
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        font-size: 1.2rem;
        font-weight: 500;
        text-align: center;
        max-width: 80%;
        line-height: 1.6;
      }

      @media (max-width: 992px) {
        .sidebar {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
          z-index: 1020;
        }

        .sidebar.show {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }

        .toggle-sidebar {
          display: block;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <div id="navbar-placeholder"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loadingText">
        Loading your assessment progress...
      </div>
    </div>

    <div class="assessment-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="progress-indicator">
          <div class="d-flex justify-content-between align-items-center">
            <span>Assessment Progress</span>
            <span class="progress-text">0%</span>
          </div>
          <div class="progress">
            <div
              class="progress-bar"
              role="progressbar"
              style="width: 0%"
              aria-valuenow="0"
              aria-valuemin="0"
              aria-valuemax="100"
            ></div>
          </div>
        </div>

        <ul class="module-list" id="module-list">
          <!-- Modules will be loaded here dynamically -->
        </ul>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="container-fluid">
          <h2 class="mb-4">Module Assessments</h2>
          <div id="assessments-container">
            <!-- Assessments will be loaded here dynamically -->
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $(document).ready(function () {
        // Load navbar
        $("#navbar-placeholder").load("../components/navbar.html");

        // Get user data from session storage
        const userData = JSON.parse(sessionStorage.getItem("user"));
        if (!userData) {
          window.location.href = "../login.html";
          return;
        }

        // Show loading overlay
        const loadingOverlay = document.getElementById("loadingOverlay");
        const loadingText = document.getElementById("loadingText");
        loadingOverlay.classList.add("active");

        // Fetch assessment progress
        fetchAssessmentProgress(userData.user_id);

        function fetchAssessmentProgress(userId) {
          fetch(`http://127.0.0.1:8000/api/v1/users/${userId}/assessment-progress`)
            .then((response) => response.json())
            .then((data) => {
              displayAssessments(data.data);
              buildModuleList(data.data);
              updateProgressIndicator(data.data);
              // Hide loading overlay
              setTimeout(() => {
                loadingOverlay.classList.remove("active");
              }, 500);
            })
            .catch((error) => {
              console.error("Error loading assessment progress:", error);
              loadingText.textContent =
                "Error loading assessment progress. Please try again later.";
              setTimeout(() => {
                loadingOverlay.classList.remove("active");
              }, 3000);
            });
        }

        function buildModuleList(assessments) {
          const moduleList = $("#module-list");
          moduleList.empty();

          // Group assessments by module
          const moduleGroups = assessments.reduce((groups, assessment) => {
            const moduleNumber = assessment.assessment.module_number;
            if (!groups[moduleNumber]) {
              groups[moduleNumber] = [];
            }
            groups[moduleNumber].push(assessment);
            return groups;
          }, {});

          // Create module items
          Object.entries(moduleGroups).forEach(([moduleNumber, moduleAssessments]) => {
            const completedCount = moduleAssessments.filter(a => a.status === "completed").length;
            const isCompleted = completedCount === moduleAssessments.length;
            const isInProgress = !isCompleted && moduleAssessments.some(a => a.status === "in_progress");

            const moduleItem = $(`
              <li class="module-item">
                <div class="module-header ${isCompleted ? 'completed' : isInProgress ? 'active' : ''}">
                  <i class="fas ${isCompleted ? 'fa-check-circle' : 'fa-book'}"></i>
                  <span>Module ${moduleNumber} Assessments</span>
                  <i class="fas fa-chevron-down ms-auto"></i>
                  ${isCompleted ? '<span class="badge bg-success">Completed</span>' : ''}
                </div>
                <ul class="assessment-list" style="display: none;">
                  ${moduleAssessments.map(assessment => `
                    <li class="assessment-item p-2 ${assessment.status === 'completed' ? 'text-success' : ''}" 
                        data-assessment-id="${assessment.assessment_progress_id}">
                      <i class="fas ${assessment.status === 'completed' ? 'fa-check-circle' : 'fa-file-alt'} me-2"></i>
                      ${assessment.assessment.assessment_title}
                    </li>
                  `).join('')}
                </ul>
              </li>
            `);

            moduleList.append(moduleItem);
          });

          // Add click handlers for module headers
          $(".module-header").click(function() {
            $(this).find(".fa-chevron-down").toggleClass("fa-chevron-up");
            $(this).siblings(".assessment-list").slideToggle();
          });

          // Add click handlers for assessment items
          $(".assessment-item").click(function() {
            const assessmentId = $(this).data("assessment-id");
            scrollToAssessment(assessmentId);
          });
        }

        function updateProgressIndicator(assessments) {
          const totalAssessments = assessments.length;
          const completedAssessments = assessments.filter(a => a.status === "completed").length;
          const progressPercentage = Math.round((completedAssessments / totalAssessments) * 100);

          $(".progress-bar").css("width", `${progressPercentage}%`);
          $(".progress-bar").attr("aria-valuenow", progressPercentage);
          $(".progress-text").text(`${progressPercentage}%`);
        }

        function scrollToAssessment(assessmentId) {
          const assessmentCard = $(`[data-assessment-id="${assessmentId}"]`).closest(".assessment-card");
          if (assessmentCard.length) {
            $('html, body').animate({
              scrollTop: assessmentCard.offset().top - 100
            }, 500);
          }
        }

        function displayAssessments(assessments) {
          const container = $("#assessments-container");
          container.empty();

          assessments.forEach((assessment) => {
            const card = createAssessmentCard(assessment);
            container.append(card);
          });
        }

        function createAssessmentCard(assessment) {
          const statusClass =
            assessment.status === "completed"
              ? "status-completed"
              : assessment.status === "in_progress"
              ? "status-in-progress"
              : "status-not-started";

          const statusText =
            assessment.status === "completed"
              ? "Completed"
              : assessment.status === "in_progress"
              ? "In Progress"
              : "Not Started";

          const card = $(`
            <div class="assessment-card" data-assessment-id="${assessment.assessment_progress_id}">
              <div class="assessment-header">
                <h3 class="assessment-title">${assessment.assessment.assessment_title}</h3>
                <div class="assessment-module">Module ${assessment.assessment.module_number}</div>
              </div>
              <div class="assessment-body">
                ${assessment.assessment.assessment_objective
                  ? `<div class="assessment-objective">
                       <strong>Objective:</strong> ${assessment.assessment.assessment_objective}
                     </div>`
                  : ""}
                ${assessment.assessment.assessment_scenario
                  ? `<div class="assessment-scenario">
                       <strong>Scenario:</strong><br>
                       ${assessment.assessment.assessment_scenario}
                     </div>`
                  : ""}
                <div class="assessment-steps">
                  <h4 class="mb-3">Assessment Steps:</h4>
                  ${assessment.assessment.assessment_instructions
                    .map(
                      (step) => `
                    <div class="assessment-step">
                      <div class="step-title">${step.step_title}</div>
                      <div class="step-description">${step.step_description}</div>
                    </div>
                  `
                    )
                    .join("")}
                </div>
              </div>
              <div class="assessment-footer">
                <span class="status-badge ${statusClass}">${statusText}</span>
                <button class="btn-start-assessment" onclick="startAssessment(${
                  assessment.assessment_progress_id
                })" ${assessment.status === "completed" ? "disabled" : ""}>
                  ${assessment.status === "completed" 
                    ? '<i class="fas fa-check"></i> Completed'
                    : assessment.status === "in_progress"
                    ? '<i class="fas fa-play"></i> Continue Assessment'
                    : '<i class="fas fa-play"></i> Start Assessment'}
                </button>
              </div>
            </div>
          `);

          return card;
        }

        // Add to global scope for button click handler
        window.startAssessment = function (assessmentProgressId) {
          // TODO: Implement assessment start functionality
          console.log("Starting assessment:", assessmentProgressId);
        };
      });
    </script>
  </body>
</html> 