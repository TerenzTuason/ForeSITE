<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Course Details - ForeSITE</title>
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      :root {
        --maroon: #800000;
        --gold: #ffb81c;
        --light-gray: #f5f5f5;
        --dark-gray: #333;
        --border-radius: 8px;
        --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      body {
        font-family: "Poppins", sans-serif;
        background-color: var(--light-gray);
        min-height: 100vh;
      }

      .navbar {
        background: var(--maroon);
        padding: 1rem 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }

      .navbar-brand {
        color: white !important;
        font-weight: 600;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .navbar-brand img {
        height: 35px;
      }

      .back-button {
        color: var(--maroon);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .back-button:hover {
        color: var(--maroon);
        transform: translateX(-5px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .course-header {
        background: white;
        padding: 3rem;
        margin-bottom: 2rem;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        position: relative;
        overflow: hidden;
      }

      .course-header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 5px;
        background: linear-gradient(to right, var(--maroon), var(--gold));
      }

      .course-title {
        color: var(--maroon);
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        line-height: 1.3;
      }

      .course-header .lead {
        font-size: 1.2rem;
        line-height: 1.8;
        color: var(--dark-gray);
        opacity: 0.9;
        margin-bottom: 2rem;
      }

      .course-section {
        background: white;
        padding: 2.5rem;
        margin-bottom: 2rem;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
      }

      .section-title {
        color: var(--maroon);
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 2rem;
        position: relative;
        padding-bottom: 0.75rem;
      }

      .section-title::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 60px;
        height: 4px;
        background: var(--gold);
        border-radius: 2px;
      }

      .course-objectives {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .course-objectives li {
        position: relative;
        padding-left: 2rem;
        margin-bottom: 1rem;
        font-size: 1.1rem;
        line-height: 1.6;
        color: var(--dark-gray);
      }

      .course-objectives li::before {
        content: "âœ“";
        position: absolute;
        left: 0;
        color: var(--maroon);
        font-weight: bold;
      }

      .module {
        margin-bottom: 1.5rem;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        transition: all 0.3s ease;
        background: white;
        position: relative;
        overflow: hidden;
      }

      .module::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 4px;
        background: var(--maroon);
        border-radius: 4px 0 0 4px;
      }

      .module:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        transform: translateY(-5px);
      }

      .module-number {
        color: var(--gold);
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .module-number::after {
        content: "";
        flex: 1;
        height: 1px;
        background: rgba(0, 0, 0, 0.1);
        margin-left: 1rem;
      }

      .module-title {
        color: var(--maroon);
        font-weight: 600;
        margin-bottom: 1rem;
        font-size: 1.3rem;
      }

      .module-focus {
        color: var(--dark-gray);
        background: var(--light-gray);
        padding: 1.25rem;
        border-radius: var(--border-radius);
        font-size: 1rem;
        line-height: 1.6;
      }

      .btn-enroll {
        background: linear-gradient(to right, var(--maroon), #600000);
        color: white;
        border: none;
        padding: 1rem 3rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(128, 0, 0, 0.3);
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
      }

      .btn-enroll:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(128, 0, 0, 0.4);
        color: white;
      }

      .btn-enroll i {
        transition: transform 0.3s ease;
      }

      .btn-enroll:hover i {
        transform: translateX(5px);
      }

      /* Base responsive container */
      .container {
        max-width: 1400px;
        padding: 0 1.5rem;
      }

      /* Responsive typography scale */
      @media (min-width: 1200px) {
        .course-title {
          font-size: 2.75rem;
        }
        .section-title {
          font-size: 2rem;
        }
        .lead {
          font-size: 1.25rem;
        }
      }

      @media (max-width: 1199px) {
        .course-title {
          font-size: 2.5rem;
        }
        .section-title {
          font-size: 1.8rem;
        }
        .course-header {
          padding: 2.5rem;
        }
      }

      @media (max-width: 991px) {
        .course-title {
          font-size: 2.25rem;
        }
        .section-title {
          font-size: 1.6rem;
        }
        .module {
          padding: 1.25rem;
        }
        .module-title {
          font-size: 1.2rem;
        }
      }

      @media (max-width: 768px) {
        .container {
          padding: 0 1rem;
        }
        .course-header {
          padding: 2rem;
        }
        .course-title {
          font-size: 2rem;
          margin-bottom: 1rem;
        }
        .section-title {
          font-size: 1.5rem;
          margin-bottom: 1.5rem;
        }
        .course-section {
          padding: 1.5rem;
        }
        .lead {
          font-size: 1.1rem;
          line-height: 1.6;
        }
        .module {
          padding: 1rem;
        }
        .module-focus {
          padding: 1rem;
        }
        .btn-enroll {
          padding: 0.875rem 2rem;
          font-size: 1rem;
        }
        .back-button {
          margin-bottom: 1rem;
        }
      }

      @media (max-width: 576px) {
        .container {
          padding: 0 0.75rem;
        }
        .course-header {
          padding: 1.5rem;
        }
        .course-title {
          font-size: 1.75rem;
        }
        .section-title {
          font-size: 1.4rem;
        }
        .course-objectives li {
          font-size: 1rem;
          padding-left: 1.75rem;
        }
        .module-number {
          font-size: 1rem;
        }
        .module-title {
          font-size: 1.1rem;
        }
        .module-focus {
          font-size: 0.95rem;
        }
        .btn-enroll {
          width: 100%;
          justify-content: center;
        }
      }

      /* Fix for very small devices */
      @media (max-width: 360px) {
        .course-title {
          font-size: 1.5rem;
        }
        .section-title {
          font-size: 1.3rem;
        }
        .module {
          padding: 0.875rem;
        }
      }

      /* Landscape orientation adjustments */
      @media (max-height: 600px) and (orientation: landscape) {
        .container {
          margin-top: 80px;
        }
        .course-header {
          padding: 1.5rem;
        }
        .course-section {
          padding: 1.25rem;
        }
      }

      /* Loading Screen Styles */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        color: white;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }

      .loading-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .loading-spinner {
        width: 80px;
        height: 80px;
        border: 8px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--gold);
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        font-size: 1.2rem;
        font-weight: 500;
        text-align: center;
        max-width: 80%;
        line-height: 1.6;
      }

      .loading-progress {
        width: 300px;
        height: 10px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 5px;
        margin-top: 20px;
        overflow: hidden;
        position: relative;
      }

      .loading-progress-bar {
        height: 100%;
        background: var(--gold);
        border-radius: 5px;
        width: 0%;
        transition: width 0.3s ease-in-out;
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <div id="navbar-placeholder"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loadingText">Enrolling in course...</div>
      <div class="loading-progress">
        <div class="loading-progress-bar" id="loadingProgressBar"></div>
      </div>
    </div>

    <div class="container" style="margin-top: 100px">
      <a href="dashboard.html" class="back-button">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>

      <div class="course-header">
        <h1 class="course-title">Loading Course...</h1>
        <p class="lead">Please wait while we fetch the course details...</p>
        <a href="course-details.html" class="btn btn-enroll">
          Enroll Now <i class="fas fa-arrow-right"></i>
        </a>
      </div>

      <div class="course-section">
        <h2 class="section-title">Course Objectives</h2>
        <ul class="course-objectives">
          <li>Loading course objectives...</li>
        </ul>
      </div>

      <div class="course-section">
        <h2 class="section-title">Course Structure</h2>
        <div class="module">
          <div class="module-number">Loading...</div>
          <h3 class="module-title">
            Please wait while we fetch the course structure...
          </h3>
          <div class="module-focus">
            <i class="fas fa-spinner fa-spin"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $(document).ready(function () {
        // Load navbar
        $("#navbar-placeholder").load("../components/navbar.html", function () {
          // After loading navbar, set active link
          const navLinks = document.querySelectorAll(".nav-link");
          navLinks.forEach((link) => {
            if (link.getAttribute("href") === "course-details.html") {
              link.classList.add("active");
            }
          });
        });
      });

      document.addEventListener("DOMContentLoaded", function () {
        // Get user data from session storage
        const userData = JSON.parse(sessionStorage.getItem("user"));
        if (!userData) {
          window.location.href = "../login.html";
          return;
        }

        // Add logout functionality
        const logoutBtn = document.querySelector(".btn-logout");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", function (e) {
            e.preventDefault();
            sessionStorage.removeItem("user");
            window.location.href = "../login.html";
          });
        }

        // Check if user has any enrollments
        fetch(
          `https://foresite-backend-collaborative-qmyiqy.laravel.cloud/api/v1/users/${userData.user_id}/enrollments`
        )
          .then((response) => response.json())
          .then((data) => {
            if (data.data && data.data.length > 0) {
              // User is already enrolled in a course, redirect to dashboard
              window.location.href = "dashboard.html";
              return;
            }

            // Check if user has taken the assessment
            fetch(
              `https://foresite-backend-collaborative-qmyiqy.laravel.cloud/api/v1/users/${userData.user_id}/assessment-results`
            )
              .then((response) => response.json())
              .then((data) => {
                if (!data.data || data.data.length === 0) {
                  // No assessment results found, redirect to questionnaire
                  window.location.href = "questionnaire.html";
                  return;
                }
                // Continue with enrollment page if assessment exists but no enrollment
                const assessmentResult = data.data[0]; // Get the most recent result
                fetchCourseDetails(assessmentResult.course_id);
              })
              .catch((error) => {
                console.error("Error fetching assessment results:", error);
                alert(
                  "Error checking assessment status. Please try again later."
                );
              });
          })
          .catch((error) => {
            console.error("Error checking enrollment status:", error);
            alert("Error checking enrollment status. Please try again later.");
          });

        // Get course ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get("id");

        if (courseId) {
          fetchCourseDetails(courseId);
        }

        function fetchCourseDetails(id) {
          fetch(`https://foresite-backend-collaborative-qmyiqy.laravel.cloud/api/v1/courses/${id}`)
            .then((response) => response.json())
            .then((data) => {
              const course = data.data;

              // Update course title and description
              document.querySelector(".course-title").textContent = course.name;
              document.querySelector(".lead").textContent = course.description;

              // Update course objectives
              const objectivesList =
                document.querySelector(".course-objectives");
              objectivesList.innerHTML = course.objectives
                .map((objective) => `<li>${objective}</li>`)
                .join("");

              // Update course structure/modules
              const courseSection = document.querySelector(
                ".course-section:last-child"
              );
              courseSection.innerHTML = `
                            <h2 class="section-title">Course Structure</h2>
                            ${course.structure
                              .map(
                                (module) => `
                                <div class="module">
                                    <div class="module-number">Module ${module.module}</div>
                                    <h3 class="module-title">${module.title}</h3>
                                    <div class="module-focus">
                                        ${module.focus}
                                    </div>
                                </div>
                            `
                              )
                              .join("")}
                        `;

              // Update enroll button to include course ID
              const enrollButton = document.querySelector(".btn-enroll");
              enrollButton.href = "#"; // Remove the href to handle click event instead
              enrollButton.addEventListener("click", async function (e) {
                e.preventDefault();

                // Show loading overlay
                const loadingOverlay = document.getElementById("loadingOverlay");
                const loadingText = document.getElementById("loadingText");
                const loadingProgressBar = document.getElementById(
                  "loadingProgressBar"
                );

                loadingOverlay.classList.add("active");
                loadingText.textContent = "Enrolling in course...";
                loadingProgressBar.style.width = "10%";

                try {
                  // Get assessment result ID from the assessment results
                  const assessmentResponse = await fetch(
                    `https://foresite-backend-collaborative-qmyiqy.laravel.cloud/api/v1/users/${userData.user_id}/assessment-results`
                  );
                  const assessmentData = await assessmentResponse.json();

                  if (
                    !assessmentData.data ||
                    assessmentData.data.length === 0
                  ) {
                    throw new Error(
                      "No assessment results found. Please complete the assessment first."
                    );
                  }

                  const assessmentResult = assessmentData.data[0]; // Get the most recent result
                  if (!assessmentResult.result_id) {
                    throw new Error("Invalid assessment result data");
                  }

                  // Prepare enrollment data
                  const enrollmentData = {
                    user_id: userData.user_id,
                    course_id: course.course_id,
                    assessment_result_id: assessmentResult.result_id,
                  };

                  console.log("Enrollment data being sent:", enrollmentData);

                  // Update loading text
                  loadingText.textContent = "Creating enrollment record...";
                  loadingProgressBar.style.width = "20%";

                  // Send enrollment request
                  const enrollResponse = await fetch(
                    "https://foresite-backend-collaborative-qmyiqy.laravel.cloud/api/v1/enrollments",
                    {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                      },
                      body: JSON.stringify(enrollmentData),
                    }
                  );

                  if (!enrollResponse.ok) {
                    throw new Error("Enrollment failed");
                  }

                  // Create module progress data based on course structure
                  const moduleProgressData = {
                    data: course.structure.map((module) => ({
                      user_id: userData.user_id,
                      course_id: course.course_id,
                      module_number: module.module,
                      module_title: module.title,
                      module_focus: module.focus,
                      status: "not_started",
                      progress_percentage: 0,
                      time_spent_minutes: 0,
                    })),
                  };

                  console.log(
                    "Module progress data being sent:",
                    moduleProgressData
                  );

                  // Update loading text
                  loadingText.textContent = "Creating module progress records...";
                  loadingProgressBar.style.width = "40%";

                  // Send module progress request
                  const moduleProgressResponse = await fetch(
                    "https://foresite-backend-collaborative-qmyiqy.laravel.cloud/api/v1/module-progress",
                    {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                      },
                      body: JSON.stringify(moduleProgressData),
                    }
                  );

                  if (!moduleProgressResponse.ok) {
                    console.warn(
                      "Module progress creation failed, but enrollment succeeded"
                    );
                  } else {
                    const moduleProgressResult = await moduleProgressResponse.json();
                    console.log(
                      "Module progress created:",
                      moduleProgressResult
                    );

                    // If module progress was created successfully, create lesson screen progress
                    if (moduleProgressResponse.ok && moduleProgressResult.data) {
                      try {
                        console.log(
                          "Module progress created successfully:",
                          moduleProgressResult.data
                        );

                        // Update loading text
                        loadingText.textContent = "Fetching lesson screens...";
                        loadingProgressBar.style.width = "60%";

                        // Create module assessment progress
                        loadingText.textContent = "Creating module assessment records...";
                        loadingProgressBar.style.width = "80%";

                        try {
                          // First fetch module assessments for this course
                          const moduleAssessmentsResponse = await fetch(
                            `https://foresite-backend-collaborative-qmyiqy.laravel.cloud/api/v1/courses/${course.course_id}/module-assessments`
                          );

                          if (!moduleAssessmentsResponse.ok) {
                            throw new Error("Failed to fetch module assessments");
                          }

                          const moduleAssessmentsResult = await moduleAssessmentsResponse.json();
                          const moduleAssessments = moduleAssessmentsResult.data;

                          // Create progress entries for each module assessment
                          for (const assessment of moduleAssessments) {
                            // Find the corresponding module progress for this assessment
                            const moduleProgress = moduleProgressResult.data.find(
                              mp => mp.module_number === assessment.module_number
                            );

                            if (!moduleProgress) {
                              console.error(
                                `No module progress found for module number ${assessment.module_number}`
                              );
                              continue;
                            }

                            const moduleAssessmentProgressData = {
                              module_assessment_id: assessment.assessment_id,
                              user_id: userData.user_id,
                              module_progress_id: moduleProgress.progress_id,
                              status: "not_started"
                            };

                            const moduleAssessmentProgressResponse = await fetch(
                              "https://foresite-backend-collaborative-qmyiqy.laravel.cloud/api/v1/module-assessment-progress",
                              {
                                method: "POST",
                                headers: {
                                  "Content-Type": "application/json",
                                },
                                body: JSON.stringify(moduleAssessmentProgressData),
                              }
                            );

                            if (!moduleAssessmentProgressResponse.ok) {
                              console.error(
                                `Failed to create progress for module assessment ${assessment.assessment_id}:`,
                                moduleAssessmentProgressResponse.status,
                                moduleAssessmentProgressResponse.statusText
                              );
                            } else {
                              console.log(
                                `Successfully created progress for module assessment ${assessment.assessment_id}`
                              );
                            }
                          }
                        } catch (error) {
                          console.error("Error creating module assessment progress:", error);
                        }

                        // Fetch all lesson screens - this is the critical part
                        console.log("Fetching lesson screens...");

                        // API endpoint for lesson screens
                        const lessonScreensUrl =
                          "https://foresite-backend-collaborative-qmyiqy.laravel.cloud/api/v1/lesson-screens";
                        console.log("Requesting lesson screens from:", lessonScreensUrl);

                        const lessonScreensResponse = await fetch(lessonScreensUrl);

                        if (!lessonScreensResponse.ok) {
                          console.error(
                            "Failed to fetch lesson screens:",
                            lessonScreensResponse.status,
                            lessonScreensResponse.statusText
                          );

                          // Try to get more details about the error
                          const errorData = await lessonScreensResponse.text();
                          console.error("Error response:", errorData);
                          throw new Error("Failed to fetch lesson screens");
                        }

                        const lessonScreensResult = await lessonScreensResponse.json();
                        console.log("Lesson screens fetched:", lessonScreensResult);

                        if (
                          !lessonScreensResult.data ||
                          !Array.isArray(lessonScreensResult.data)
                        ) {
                          console.error(
                            "Invalid lesson screens data format:",
                            lessonScreensResult
                          );
                          throw new Error("Invalid lesson screens data format");
                        }

                        const lessonScreens = lessonScreensResult.data;
                        console.log("Number of lesson screens found:", lessonScreens.length);

                        if (lessonScreens.length === 0) {
                          console.warn("No lesson screens found in the database");
                        } else {
                          // Create mapping of module numbers to module progress IDs
                          const moduleProgressMap = {};
                          moduleProgressResult.data.forEach((module) => {
                            moduleProgressMap[module.module_number] = module.progress_id;
                          });

                          console.log("Module progress map:", moduleProgressMap);

                          // Group lesson screens by module number based on screen_number prefix
                          const screensByModule = {};

                          lessonScreens.forEach((screen) => {
                            // Extract module number from screen_number (e.g., "1.1" -> 1, "2" -> 2, "3.1.2" -> 3)
                            // Make sure to only take the first digit even for complex numbering like "3.1.2"
                            const moduleNumber = parseInt(
                              screen.screen_number.split(".")[0]
                            );

                            console.log(
                              `Screen ${screen.screen_number} mapped to module ${moduleNumber}`
                            );

                            if (!isNaN(moduleNumber)) {
                              if (!screensByModule[moduleNumber]) {
                                screensByModule[moduleNumber] = [];
                              }
                              screensByModule[moduleNumber].push(screen);
                            }
                          });

                          console.log("Screens grouped by module:", screensByModule);

                          // Create lesson screen progress for each module
                          for (const [moduleNumber, screens] of Object.entries(
                            screensByModule
                          )) {
                            const moduleProgressId = moduleProgressMap[moduleNumber];

                            if (moduleProgressId) {

                              // Update loading text
                              loadingText.textContent = `Creating progress records for module ${moduleNumber}...`;
                              loadingProgressBar.style.width = `${60 + parseInt(moduleNumber) * 10}%`;

                              // Create lesson screen progress data - removed 'data' wrapper based on API error
                              // The API expects each item to be sent individually, not as an array
                              for (let i = 0; i < screens.length; i++) {
                                const screen = screens[i];
                                // Check if this is the very first screen of the first module
                                const isFirstScreen = (parseInt(moduleNumber) === 1 && i === 0);
                                
                                const lessonScreenProgressData = {
                                  module_progress_id: moduleProgressId,
                                  lesson_screen_id: screen.lesson_screen_id,
                                  course_module_number: parseInt(moduleNumber),
                                  status: isFirstScreen ? "in_progress" : "not_started",
                                  progress_percentage: isFirstScreen ? 50 : 0,
                                };

                                // Send lesson screen progress request for this individual screen
                                const lessonScreenProgressUrl = `https://foresite-backend-collaborative-qmyiqy.laravel.cloud/api/v1/module-progress/${moduleProgressId}/screen-progress`;
                                console.log(`Posting to URL: ${lessonScreenProgressUrl}`);

                                try {
                                  const lessonScreenProgressResponse = await fetch(
                                    lessonScreenProgressUrl,
                                    {
                                      method: "POST",
                                      headers: {
                                        "Content-Type": "application/json",
                                      },
                                      body: JSON.stringify(lessonScreenProgressData),
                                    }
                                  );

                                  if (!lessonScreenProgressResponse.ok) {
                                    console.error(
                                      `Lesson screen progress creation failed for screen ${screen.screen_number}:`,
                                      lessonScreenProgressResponse.status,
                                      lessonScreenProgressResponse.statusText
                                    );

                                    // Try to get more details about the error
                                    const errorData = await lessonScreenProgressResponse.text();
                                    console.error("Error response:", errorData);
                                  } else {
                                    const responseData = await lessonScreenProgressResponse.json();
                                    console.log(
                                      `Successfully created lesson screen progress for screen ${screen.screen_number}:`,
                                      responseData
                                    );
                                  }
                                } catch (fetchError) {
                                  console.error(
                                    `Error posting lesson screen progress for screen ${screen.screen_number}:`,
                                    fetchError
                                  );
                                }
                              }

                              console.log(
                                `Processed ${screens.length} screens for module ${moduleNumber}`
                              );
                            } else {
                              console.warn(
                                `No module progress found for module number ${moduleNumber}`
                              );
                            }
                          }
                        }
                      } catch (error) {
                        console.error("Error creating lesson screen progress:", error);
                      }
                    }
                  }

                  // Update loading text for completion
                  loadingText.textContent = "Enrollment complete!";
                  loadingProgressBar.style.width = "100%";

                  const enrollResult = await enrollResponse.json();

                  // Wait a moment to show the completion message before redirecting
                  setTimeout(() => {
                    window.location.href = `course-details.html?id=${course.course_id}`;
                  }, 1000);
                } catch (error) {
                  console.error("Error during enrollment:", error);

                  // Update loading overlay to show error
                  loadingText.textContent = "Failed to enroll in the course. Please try again later.";
                  loadingProgressBar.style.width = "100%";
                  loadingProgressBar.style.backgroundColor = "#ff4444";

                  // Hide loading overlay after a delay
                  setTimeout(() => {
                    loadingOverlay.classList.remove("active");
                  }, 3000);
                }
              });
            })
            .catch((error) => {
              console.error("Error fetching course details:", error);
              document.querySelector(".course-title").textContent =
                "Error loading course";
              document.querySelector(".lead").textContent =
                "There was an error loading the course details. Please try again later.";
            });
        }
      });
    </script>
  </body>
</html>