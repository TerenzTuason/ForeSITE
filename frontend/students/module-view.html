<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Module View - ForeSITE</title>
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      :root {
        --maroon: #800000;
        --gold: #ffb81c;
        --light-gray: #f5f5f5;
        --dark-gray: #333;
        --border-radius: 8px;
        --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        --sidebar-width: 320px;
      }

      body {
        font-family: "Poppins", sans-serif;
        background-color: var(--light-gray);
        min-height: 100vh;
        overflow-x: hidden;
      }

      .navbar {
        background: var(--maroon);
        padding: 1rem 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 1030;
      }

      .navbar-brand {
        color: white !important;
        font-weight: 600;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .navbar-brand img {
        height: 35px;
      }

      .course-container {
        display: flex;
        margin-top: 56px;
      }

      .sidebar {
        width: var(--sidebar-width);
        background: white;
        height: calc(100vh - 56px);
        position: fixed;
        left: 0;
        overflow-y: auto;
        padding: 1.5rem;
        border-right: 1px solid #eee;
      }

      .main-content {
        margin-left: var(--sidebar-width);
        flex: 1;
        padding: 2rem;
        min-height: calc(100vh - 56px);
      }

      .module-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .module-item {
        margin-bottom: 1rem;
        border: 1px solid #eee;
        border-radius: var(--border-radius);
        overflow: hidden;
      }

      .module-header {
        padding: 1rem;
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .module-header.active {
        background: var(--maroon);
        color: white;
      }

      .module-header.locked {
        background-color: #e9ecef;
        color: #6c757d;
        cursor: not-allowed;
      }

      /* Removed locked state styling as per requirements */
      .module-header,
      .lesson-item {
        cursor: pointer !important;
      }

      .module-header.completed {
        background: #d4edda;
        color: #155724;
        border-color: #c3e6cb;
      }

      .badge {
        font-size: 0.75em;
        padding: 0.35em 0.65em;
        border-radius: 0.25rem;
      }

      .bg-success {
        background-color: #28a745 !important;
        color: white;
      }

      .lesson-list {
        list-style: none;
        padding: 0.5rem 0;
        margin: 0;
        background: white;
      }

      .lesson-item {
        padding: 0.75rem 1rem 0.75rem 2rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--dark-gray);
        border-left: 3px solid transparent;
      }

      .lesson-item:hover {
        background: #f8f9fa;
      }

      .lesson-item.active {
        background: #f8f9fa;
        border-left-color: var(--maroon);
        color: var(--maroon);
      }

      .lesson-item.completed {
        color: var(--success-green);
      }

      .content-container {
        background: white;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--card-shadow);
        max-width: 1200px;
        margin: 0 auto;
      }

      .content-header {
        padding: 2rem;
        border-bottom: 1px solid #eee;
        background: linear-gradient(135deg, var(--maroon) 0%, #600000 100%);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .content-title {
        font-size: 2rem;
        margin: 0;
        color: white;
        font-weight: 600;
        letter-spacing: 0.5px;
      }

      .content-body {
        padding: 2.5rem;
        min-height: 400px;
        line-height: 1.8;
      }

      .lesson-content {
        max-width: 900px;
        margin: 0 auto;
      }

      .lesson-content p {
        font-size: 1.1rem;
        color: #2c3e50;
        margin-bottom: 1.5rem;
        line-height: 1.8;
      }

      .lesson-content ul {
        background: #f8f9fa;
        padding: 1.5rem 2rem 1.5rem 3.5rem;
        border-radius: 8px;
        margin: 1.5rem 0;
      }

      .lesson-content li {
        margin-bottom: 1rem;
        color: #2c3e50;
        position: relative;
      }

      .lesson-content li::before {
        content: "â€¢";
        color: var(--maroon);
        font-weight: bold;
        position: absolute;
        left: -1.2rem;
      }

      .video-container {
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        margin: 2rem auto;
        max-width: 900px;
      }

      .video-content {
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        margin: 2rem auto;
        max-width: 900px;
      }

      .image-content {
        text-align: center;
        margin: 2rem auto;
        max-width: 900px;
      }

      .image-content img {
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        max-width: 100%;
        height: auto;
      }

      .alert {
        border: none;
        border-radius: 8px;
        padding: 1.25rem;
        margin: 1.5rem auto;
        max-width: 900px;
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .alert i {
        font-size: 1.25rem;
      }

      .alert-info {
        background: rgba(var(--maroon), 0.1);
        color: var(--maroon);
      }

      .video-progress-indicator {
        text-align: center;
        margin: 1rem auto;
        max-width: 900px;
        font-size: 0.95rem;
      }

      .content-footer {
        padding: 1.5rem 2.5rem;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8f9fa;
      }

      .nav-button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .btn-back {
        background-color: #e9ecef;
        color: #495057;
      }

      .btn-back:hover:not(:disabled) {
        background-color: #dee2e6;
        transform: translateX(-2px);
      }

      .btn-continue {
        background: linear-gradient(135deg, var(--maroon) 0%, #600000 100%);
        color: white;
      }

      .btn-continue:hover:not(:disabled) {
        transform: translateX(2px);
        box-shadow: 0 4px 12px rgba(128, 0, 0, 0.2);
      }

      .nav-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
      }

      .lead {
        font-size: 1.25rem;
        color: #6c757d;
        margin-bottom: 2rem;
        line-height: 1.8;
        font-weight: 300;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
      }

      .progress-indicator {
        margin-top: 2.5rem;
        margin-bottom: 2rem;
      }

      .progress {
        height: 0.5rem;
        background-color: #e9ecef;
        margin-top: 0.5rem;
      }

      .progress-bar {
        background-color: var(--maroon);
        border-radius: 4px;
      }

      /* Loading screen styles */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        color: white;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }

      .loading-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .loading-spinner {
        width: 80px;
        height: 80px;
        border: 8px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--gold);
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        font-size: 1.2rem;
        font-weight: 500;
        text-align: center;
        max-width: 80%;
        line-height: 1.6;
      }

      /* Floating assessment button styles */
      .floating-assessment-btn {
        position: fixed;
        top: 120px;  /* Changed from 80px to 120px to move it down */
        right: 20px;
        z-index: 1000;
        background-color: var(--maroon);
        color: white;
        padding: 10px 20px;
        border-radius: var(--border-radius);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        display: none;
        text-decoration: none;
        transition: all 0.3s ease;
      }

      .floating-assessment-btn:hover {
        background-color: #600000;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .floating-assessment-btn i {
        margin-right: 8px;
      }

      /* Content type specific styles */
      .video-container {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
        height: 0;
        overflow: hidden;
      }

      .video-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
      }

      .video-container video.loading {
        background: #000 url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxjaXJjbGUgY3g9IjI1IiBjeT0iMjUiIHI9IjIwIiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLWRhc2hhcnJheT0iODAgODAiPgogICAgICAgIDxhbmltYXRlVHJhbnNmb3JtIGF0dHJpYnV0ZU5hbWU9InRyYW5zZm9ybSIgdHlwZT0icm90YXRlIiBmcm9tPSIwIDI1IDI1IiB0bz0iMzYwIDI1IDI1IiBkdXI9IjFzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSIvPgogICAgPC9jaXJjbGU+Cjwvc3ZnPg==') center center no-repeat;
      }

      .video-content {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
        height: 0;
        overflow: hidden;
      }

      .video-content iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      .text-content {
        color: var(--dark-gray);
      }

      .text-content h3 {
        color: var(--maroon);
        margin-bottom: 1rem;
      }

      .text-content h5 {
        color: #6c757d;
        font-weight: 500;
        margin-bottom: 1.5rem;
      }

      .text-content p {
        line-height: 1.7;
        margin-bottom: 1rem;
      }

      .text-content ul {
        margin-bottom: 1rem;
      }

      .text-content li {
        margin-bottom: 0.5rem;
      }

      .quiz-content {
        max-width: 800px;
        margin: 0 auto;
      }

      .quiz-question {
        margin-bottom: 2rem;
      }

      .quiz-options {
        list-style: none;
        padding: 0;
      }

      .quiz-option {
        padding: 1rem;
        margin-bottom: 0.75rem;
        border: 1px solid #ced4da;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: all 0.2s;
      }

      .quiz-option:hover {
        background-color: #f8f9fa;
      }

      .quiz-option.selected {
        background-color: #e9ecef;
        border-color: #ced4da;
      }

      .quiz-option.correct {
        background-color: #d4edda;
        border-color: #28a745;
        color: #155724;
      }

      .quiz-option.incorrect {
        background-color: #f8d7da;
        border-color: #dc3545;
        color: #721c24;
      }

      @media (max-width: 992px) {
        .sidebar {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
          z-index: 1020;
        }

        .sidebar.show {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }

        .toggle-sidebar {
          display: block;
        }
      }

      #rubricsModal .modal-body {
        padding: 2rem;
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <div id="navbar-placeholder"></div>

    <!-- Floating Assessment Button -->
    <a href="assessment-view.html" class="floating-assessment-btn" id="assessmentButton">
      <i class="fas fa-clipboard-check"></i>
      Take Assessment
    </a>

    <!-- Rubrics Modal -->
    <div class="modal fade" id="rubricsModal" tabindex="-1" aria-labelledby="rubricsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="rubricsModalLabel">Rubrics for activities with open-ended questions:</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <img src="../assets/rubrics/rubrics.PNG" class="img-fluid" alt="Rubrics">
          </div>
        </div>
      </div>
    </div>

    <!-- Add modal HTML before the loading overlay -->
    <div class="modal fade" id="lockedModuleModal" tabindex="-1" aria-labelledby="lockedModuleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="lockedModuleModalLabel">Module Locked</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>You must pass the assessment for the previous module before you can access this one.</p>
            <p>Please complete the required assessment to unlock this module.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="window.location.href='assessment-view.html'">Go to Assessments</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="assessment-modal modal fade" id="assessmentModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="assessmentModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="assessmentModalLabel">Module Assessment Available</h5>
          </div>
          <div class="modal-body">
            <p>You have completed this module! The module assessment is now available.</p>
            <p>Please proceed to the assessment page to complete your evaluation.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="window.location.href='assessment-view.html'">
              Go to Assessment
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loadingText">
        Loading your course content...
      </div>
    </div>

    <div class="course-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="progress-indicator">
          <div class="d-flex justify-content-between align-items-center">
            <span>Course Progress</span>
            <span class="progress-text">0%</span>
          </div>
          <div class="progress">
            <div
              class="progress-bar"
              role="progressbar"
              style="width: 0%"
              aria-valuenow="0"
              aria-valuemin="0"
              aria-valuemax="100"
            ></div>
          </div>
        </div>

        <ul class="module-list" id="module-list">
          <!-- Modules and lesson screens will be loaded dynamically -->
        </ul>
      </div>
      <!-- Main Content -->
      <div class="main-content">
        <div class="content-container">
          <div class="content-header">
            <h2 class="content-title"></h2>
            <button type="button" class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#rubricsModal">
              View Rubrics
            </button>
          </div>
          <div class="content-body">
            <!-- Content will be loaded dynamically -->
          </div>
          <div class="content-footer">
            <button class="nav-button btn-back" disabled>
              <i class="fas fa-arrow-left"></i> Back
            </button>
            <button class="nav-button btn-continue" disabled>
              Continue <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $(document).ready(function () {
        // Add this near the top of the $(document).ready function
        let assessmentModal;
        let lockedModuleModal;
        
        // Initialize the modal once the DOM is ready
        assessmentModal = new bootstrap.Modal(
          document.getElementById('assessmentModal'),
          { backdrop: 'static', keyboard: false }
        );
        lockedModuleModal = new bootstrap.Modal(document.getElementById('lockedModuleModal'));

        // Load navbar
        $("#navbar-placeholder").load("../components/navbar.html");

        // Get user data from session storage
        const userData = JSON.parse(sessionStorage.getItem("user"));
        if (!userData) {
          window.location.href = "../login.html";
          return;
        }

        // Initialize variables
        let currentModuleProgress = null;
        let currentLessonScreenProgress = null;
        let moduleProgressData = [];
        let assessmentProgressData = [];
        let scoresData = [];
        let allLessonScreens = [];
        let screenProgressData = [];
        let lessonScreenProgressByModule = {};

        // Global variable to store the complete API response
        let allProgressData = null;

        // CSS styles for lesson statuses
        const styleSheet = document.createElement("style");
        styleSheet.id = "progress-styles";
        styleSheet.innerHTML = `
                .lesson-item.disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                    color: #6c757d;
                }
                .lesson-item.completed {
                    color: #28a745;
                }
                .lesson-item.completed i {
                    color: #28a745;
                }
                .lesson-item.in-progress {
                    color: var(--maroon);
                    font-weight: 500;
                }
            `;
        document.head.appendChild(styleSheet);

        // Show loading overlay
        const loadingOverlay = document.getElementById("loadingOverlay");
        const loadingText = document.getElementById("loadingText");
        loadingOverlay.classList.add("active");

        // Fetch user's module progress
        fetchModuleProgress(userData.user_id);

        // Toggle module lists (attach as delegated event for dynamically created elements)
        $(document).on("click", ".module-header", function () {
          if ($(this).hasClass("locked")) {
            lockedModuleModal.show();
            return;
          }
          $(this).siblings(".lesson-list").slideToggle();
          $(this).find(".fa-chevron-down").toggleClass("fa-chevron-up");
        });

        // Handle lesson item clicks
        $(document).on("click", ".lesson-item", function (e) {
          // Check if the module is locked
          if ($(this).closest('.module-item').find('.module-header').hasClass('locked')) {
            e.preventDefault();
            e.stopPropagation();
            lockedModuleModal.show();
            return false;
          }
          
          // Check if the item is disabled
          if ($(this).hasClass("disabled")) {
            e.preventDefault();
            e.stopPropagation();
            return false;
          }

          const lessonId = $(this).attr("id");
          const parts = lessonId.split("-");
          const type = parts[0]; // 'screen'

          // Remove active class from all lesson items
          $(".lesson-item").removeClass("active");
          // Add active class to clicked lesson item
          $(this).addClass("active");

          if (type === "screen") {
            // Check if this is a video screen (ends with -video)
            const isVideoScreen =
              parts.includes("video") || parts[parts.length - 1] === "video";

            // Build the screen number based on the ID parts
            let screenNumber;

            if (isVideoScreen) {
              // For video screens like "screen-3-1-video", the screen number is "3.1-video"
              // Remove 'screen' and 'video' parts and join the middle parts with dots
              const numberParts = parts.slice(1, parts.length - 1);
              screenNumber = numberParts.join(".") + "-video";
            } else if (parts.length === 2) {
              // For screens like "screen-1", keep as "1"
              screenNumber = parts[1];
            } else {
              // For regular screens, join the number parts with dots
              // For example, "screen-3-1" becomes "3.1"
              const numberParts = parts.slice(1);
              screenNumber = numberParts.join(".");
            }

            console.log("Looking for screen with number:", screenNumber);
            const lessonScreen = allLessonScreens.find(
              (screen) => screen.screen_number === screenNumber
            );

            if (lessonScreen) {
              displayLessonScreen(lessonScreen);
            } else {
              console.error("Lesson screen not found:", screenNumber);
            }
          }
        });

        /**
         * Fetch all progress data for the user
         */
        function fetchModuleProgress(userId) {
          loadingText.textContent = "Loading your course data...";
          fetch(`https://foresite-backend-deployment-qspo9z.laravel.cloud/api/v1/users/${userId}/all-progress`)
            .then((response) => response.json())
            .then((data) => {
              // Store the complete API response in the global variable
              allProgressData = data;

              // Process the allProgressData to populate our UI data structures
              return processAllProgressData();
            })
            .then((success) => {
              if (success) {
                // Fetch assessment progress after processing module data
                loadingText.textContent = "Loading assessment scores...";
                return fetch(`https://foresite-backend-deployment-qspo9z.laravel.cloud/api/v1/users/${userId}/assessment-progress`);
              } else {
                return Promise.reject("Failed to process module progress");
              }
            })
            .then(response => response.json())
            .then(assessmentData => {
                assessmentProgressData = assessmentData.data || [];
                const scorePromises = assessmentProgressData.map(progress =>
                    fetch(`https://foresite-backend-deployment-qspo9z.laravel.cloud/api/v1/scores/assessment-progress/${progress.assessment_progress_id}`)
                        .then(res => res.json())
                        .then(scoreRes => (scoreRes.data && scoreRes.data.length > 0) ? scoreRes.data[0] : null)
                        .catch(() => null) // Handle cases where score fetching fails for one item
                );
                return Promise.all(scorePromises);
            })
            .then((scores) => {
              scoresData = scores.filter(s => s !== null);

              // Build module list in sidebar
              buildModuleList();

              // Find the single in-progress screen across all modules
              const inProgressScreen = screenProgressData.find(
                (progress) => progress.status === "in_progress"
              );

              if (inProgressScreen) {
                // Find the corresponding lesson screen
                const lessonScreen = allLessonScreens.find(
                  (screen) =>
                    screen.lesson_screen_id ===
                    inProgressScreen.lesson_screen_id
                );

                if (lessonScreen) {
                  // Get the module number from the screen number
                  const moduleNumber = parseInt(
                    lessonScreen.screen_number.split(".")[0]
                  );

                  // Check if module is locked
                  if (isModuleLocked(moduleNumber)) {
                    // If locked, show the modal and stop.
                    lockedModuleModal.show();
                    loadingOverlay.classList.remove("active");
                    return;
                  }

                  // Select the module first
                  selectModule(moduleNumber);

                  // Find and click the corresponding lesson item
                  let lessonItemId;
                  if (lessonScreen.screen_number.includes("-video")) {
                    // Handle video screens
                    const baseNumber = lessonScreen.screen_number.replace(
                      "-video",
                      ""
                    );
                    const parts = baseNumber.split(".");
                    lessonItemId = `screen-${parts.join("-")}-video`;
                  } else {
                    // Handle regular screens
                    const parts = lessonScreen.screen_number.split(".");
                    lessonItemId = `screen-${parts.join("-")}`;
                  }

                  // Find and click the lesson item
                  const lessonItem = $(`#${lessonItemId}`);
                  if (lessonItem.length) {
                    // Make sure the module's lesson list is visible
                    lessonItem.closest(".lesson-list").show();
                    lessonItem
                      .closest(".module-item")
                      .find(".module-header .fa-chevron-down")
                      .addClass("fa-chevron-up");

                    // Click the lesson item
                    lessonItem.click();

                    // Make sure continue button is enabled
                    $(".btn-continue").prop("disabled", false);

                    // Hide loading overlay and exit
                    setTimeout(() => {
                      loadingOverlay.classList.remove("active");
                    }, 500);
                    return;
                  }
                }
              }

              // If no in-progress screen found or something went wrong, default to first lesson
              console.log(
                "No in-progress screen found or error occurred, defaulting to first lesson"
              );

              // Find the first module that is not locked
              const firstUnlockedModule = moduleProgressData.find(m => !isModuleLocked(m.module_number));

              if (firstUnlockedModule) {
                // Select the first unlocked module
                selectModule(firstUnlockedModule.module_number);

                const firstLesson = $(
                  `#module-${firstUnlockedModule.module_number}-lessons .lesson-item:first`
                );
                if (firstLesson.length) {
                  firstLesson.click();
                  // Make sure continue button is clickable for first screen
                  $(".btn-continue").prop("disabled", false);
                }
              }

              // Hide loading overlay
              setTimeout(() => {
                loadingOverlay.classList.remove("active");
              }, 500);
            })
            .catch((error) => {
              console.error("Error loading module progress:", error);
              // Show error in loading overlay
              loadingText.textContent =
                "Error loading course data. Please try again later.";
              // Hide loading overlay after a delay
              setTimeout(() => {
                loadingOverlay.classList.remove("active");
              }, 3000);
            });
        }

        /**
         * Process the allProgressData to extract necessary information
         */
        function processAllProgressData() {
          if (
            !allProgressData ||
            !allProgressData.data ||
            allProgressData.data.length === 0
          ) {
            console.log("No course data found for user");
            return false;
          }

          // Process the response data
          const courseData = allProgressData.data[0]; // Get the first course

          // Extract module progress data
          if (!courseData.modules || courseData.modules.length === 0) {
            console.log("No modules found in the response");
            return false;
          }

          // Set module progress data from global state
          moduleProgressData = courseData.modules;

          // Create a collection of all lesson screens from all modules
          allLessonScreens = [];
          screenProgressData = [];

          // Process each module to extract lesson screens and screen progress
          courseData.modules.forEach((module) => {
            if (module.lesson_screens && module.lesson_screens.length > 0) {
              // Extract screen progress data
              module.lesson_screens.forEach((screenProgress) => {
                // Add to screen progress data
                screenProgressData.push(screenProgress);

                // Add screen details to allLessonScreens if not already there
                if (screenProgress.lesson_screen) {
                  const existingScreen = allLessonScreens.find(
                    (s) =>
                      s.lesson_screen_id ===
                      screenProgress.lesson_screen.lesson_screen_id
                  );

                  if (!existingScreen) {
                    allLessonScreens.push(screenProgress.lesson_screen);
                  }
                }
              });
            }
          });

          // Update progress UI immediately after processing data
          updateProgressUI();

          return true;
        }

        /**
         * Update lesson screen progress
         */
        function updateLessonScreenProgress(
          screenNumber,
          status,
          percentage,
          callback
        ) {
          // Find the lesson screen with this screen number
          const lessonScreen = allLessonScreens.find(
            (screen) => screen.screen_number === screenNumber
          );
          if (!lessonScreen) {
            console.error(
              "Cannot find lesson screen with number:",
              screenNumber
            );
            if (callback) callback();
            return;
          }

          // Find the screen progress for this lesson screen
          let screenProgress = screenProgressData.find(
            (progress) =>
              progress.lesson_screen_id === lessonScreen.lesson_screen_id
          );

          if (screenProgress) {
            // Update existing screen progress with the correct field name
            const updateData = {
              status: status,
              progress_percentage: percentage,
            };

            fetch(
              `https://foresite-backend-deployment-qspo9z.laravel.cloud/api/v1/screen-progress/${screenProgress.screen_progress_id}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(updateData),
              }
            )
              .then((response) => response.json())
              .then((data) => {
                // Update local screen progress data
                screenProgress.status = status;
                screenProgress.progress_percentage = percentage;

                // Update the global state to keep everything in sync
                updateGlobalProgressData(
                  screenProgress.screen_progress_id,
                  status,
                  percentage
                );

                // Update UI to reflect changes
                updateLessonScreenAccess();

                if (callback) callback();
              })
              .catch((error) => {
                console.error("Error updating screen progress:", error);
                if (callback) callback();
              });
          } else {
            // Screen progress should already exist but was not found in local data
            // This is an edge case - log it and call the callback
            console.log(
              "Screen progress not found for lesson screen:",
              lessonScreen
            );
            console.log(
              "This is expected to exist already since screen progress is created elsewhere"
            );
            if (callback) callback();
          }
        }

        /**
         * Update the global allProgressData variable for module progress changes
         */
        function updateGlobalModuleProgress(
          moduleProgressId,
          status,
          percentage
        ) {
          if (
            !allProgressData ||
            !allProgressData.data ||
            allProgressData.data.length === 0
          ) {
            return; // No global data to update
          }

          const courseData = allProgressData.data[0];
          if (!courseData.modules) return;

          // Find the module in the global data and update it
          for (let i = 0; i < courseData.modules.length; i++) {
            if (courseData.modules[i].progress_id === moduleProgressId) {
              courseData.modules[i].status = status;
              courseData.modules[i].progress_percentage = percentage;
              break;
            }
          }
        }

        /**
         * Update the global allProgressData variable to keep it in sync with screen progress changes
         */
        function updateGlobalProgressData(
          screenProgressId,
          status,
          percentage,
          isNewEntry = false
        ) {
          if (
            !allProgressData ||
            !allProgressData.data ||
            allProgressData.data.length === 0
          ) {
            return; // No global data to update
          }

          const courseData = allProgressData.data[0];
          if (!courseData.modules) return;

          // Loop through all modules and their lesson screens to find the matching screen progress
          let found = false;

          for (const module of courseData.modules) {
            if (!module.lesson_screens) continue;

            for (let i = 0; i < module.lesson_screens.length; i++) {
              const screenProgress = module.lesson_screens[i];

              if (screenProgress.screen_progress_id === screenProgressId) {
                // Update the existing entry
                module.lesson_screens[i].status = status;
                module.lesson_screens[i].progress_percentage = percentage;
                found = true;
                break;
              }
            }

            if (found) break;
          }

          // If it's a new entry and we didn't find an existing one to update
          if (isNewEntry && !found) {
            // Find the module that this screen progress belongs to
            const currentModuleId = currentModuleProgress
              ? currentModuleProgress.progress_id
              : null;
            if (currentModuleId) {
              const targetModule = courseData.modules.find(
                (m) => m.progress_id === currentModuleId
              );
              if (targetModule) {
                // Find the actual progress data that was just added (we have it in screenProgressData)
                const newScreenProgress = screenProgressData.find(
                  (sp) => sp.screen_progress_id === screenProgressId
                );
                if (newScreenProgress) {
                  // Add it to the global state
                  if (!targetModule.lesson_screens) {
                    targetModule.lesson_screens = [];
                  }
                  targetModule.lesson_screens.push(newScreenProgress);
                }
              }
            }
          }

          // After updating screen progress, we may need to update module progress calculations
          // This happens naturally when updateModuleProgress() is called separately
        }

        /**
         * Update module progress based on screen progress
         */
        function updateModuleProgress() {
          if (!currentModuleProgress) return;

          // Find all screen progress items for current module
          const moduleScreens = screenProgressData.filter(
            (progress) =>
              progress.module_progress_id === currentModuleProgress.progress_id
          );

          // Count completed screens
          const totalScreens = moduleScreens.length;
          const completedScreens = moduleScreens.filter(
            (screen) => screen.status === "completed"
          ).length;

          // Calculate percentage based on completed screens with exact values
          // For example, with 6 screens: 16%, 33%, 50%, 66%, 83%, 100%
          let percentage = 0;
          if (totalScreens > 0 && completedScreens > 0) {
            // Use integer division for exact percentage values
            // Round to integer to avoid floating point inconsistencies
            percentage = Math.floor((completedScreens * 100) / totalScreens);

            // If all screens are completed, ensure it shows 100%
            if (completedScreens === totalScreens) {
              percentage = 100;
            }

            // Force to match specific values for 1/3, 2/3, etc. to match the database exactly
            if (totalScreens === 6) {
              // For 6 screens, use specific percentage values
              const exactPercentages = [0, 16, 33, 50, 66, 83, 100];
              percentage = exactPercentages[completedScreens];
            } else if (totalScreens === 3) {
              // For 3 screens, use 33%, 66%, 100%
              const exactPercentages = [0, 33, 66, 100];
              percentage = exactPercentages[completedScreens];
            }

            console.log(
              `Module progress: ${completedScreens}/${totalScreens} screens completed = ${percentage}%`
            );
          }

          // Determine status - set to in_progress once at least one screen is completed
          let status = "not_started";
          if (completedScreens > 0) {
            status =
              completedScreens === totalScreens ? "completed" : "in_progress";
          }
          if (percentage === 100) {
            status = "completed";
          } else if (percentage > 0) {
            status = "in_progress";
          }

          // Update module progress
          const updateData = {
            status: status,
            progress_percentage: percentage,
          };

          fetch(
            `https://foresite-backend-deployment-qspo9z.laravel.cloud/api/v1/module-progress/${currentModuleProgress.progress_id}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(updateData),
            }
          )
            .then((response) => response.json())
            .then((data) => {
              // Update local module progress data with the returned data from server
              if (data.data) {
                // Use the data returned from the server to ensure consistency
                currentModuleProgress = data.data;
              } else {
                // Fallback to manually updating if server doesn't return full data
                currentModuleProgress.status = status;
                currentModuleProgress.progress_percentage = percentage;
              }

              // Find module in moduleProgressData and update it
              const moduleIndex = moduleProgressData.findIndex(
                (module) =>
                  module.progress_id === currentModuleProgress.progress_id
              );
              if (moduleIndex !== -1) {
                moduleProgressData[moduleIndex] = currentModuleProgress;
              }

              // Update the global data to keep it in sync
              updateGlobalModuleProgress(
                currentModuleProgress.progress_id,
                status,
                percentage
              );

              // Force refresh all UI elements to show new progress
              updateProgressUI();

              // Log the updated progress
              console.log(
                "Module progress updated:",
                currentModuleProgress.progress_percentage + "%"
              );
            })
            .catch((error) => {
              console.error("Error updating module progress:", error);
            });
        }

        /**
         * Update UI elements to show current progress
         */
        function updateProgressUI() {
          // Calculate overall course progress based on module progress percentages
          const totalModules = moduleProgressData.length;
          const totalProgress = moduleProgressData.reduce(
            (sum, module) => sum + module.progress_percentage,
            0
          );
          const coursePercentage = Math.round(totalProgress / totalModules);

          // Update progress bar with calculated percentage
          $(".progress-bar").css("width", `${coursePercentage}%`);
          $(".progress-bar").attr("aria-valuenow", coursePercentage);
          $(".progress-text").text(`${coursePercentage}%`);

          // Update module headers
          moduleProgressData.forEach((module) => {
            const moduleHeader = $(
              `#module-${module.module_number} .module-header`
            );

            // Remove existing classes
            moduleHeader.removeClass("active completed locked");

            // Add appropriate class based on status
            if (module.status === "completed") {
              moduleHeader.addClass("completed");
              // If module is completed, ensure all its lessons are also marked as completed
              const lessonItems = $(`#module-${module.module_number}-lessons .lesson-item`);
              lessonItems.removeClass("in-progress disabled").addClass("completed");
              lessonItems.find("i").removeClass("fa-file-alt fa-video").addClass("fa-check-circle");
            } else if (module.status === "in_progress") {
              moduleHeader.addClass("active");
            }

            // Show/hide assessment button based on current module progress
            if (currentModuleProgress && currentModuleProgress.progress_percentage >= 80) {
              $("#assessmentButton").show();
            } else {
              $("#assessmentButton").hide();
            }
          });
        }

        /**
         * Update which lesson screens the user can access - Simplified to just mark status
         * without restricting access to any screens
         */
        function updateLessonScreenAccess() {
          // Check if module progress exists for the current module
          if (!currentModuleProgress) {
            console.log("No module progress found for current module");
            return;
          }

          // Find module screen progress for this module
          const moduleScreens = screenProgressData.filter(
            (progress) =>
              progress.module_progress_id === currentModuleProgress.progress_id
          );

          // Go through each lesson item and update status and accessibility
          $(".lesson-item").each(function () {
            const lessonId = $(this).attr("id");
            const parts = lessonId.split("-");
            const type = parts[0];

            // Skip if not a screen
            if (type !== "screen") return;

            // Get screen number in format used in database
            let screenNumber;
            if (parts.length === 2) {
              // For "screen-1" format
              screenNumber = parts[1];
            } else if (parts.length > 2) {
              // For "screen-1-2" or "screen-1-2-video" format
              const isVideo = parts[parts.length - 1] === "video";
              if (isVideo) {
                // For video screens, join middle parts with dot and add -video
                screenNumber = parts.slice(1, -1).join(".") + "-video";
              } else {
                // For regular screens, join all number parts with dot
                screenNumber = parts.slice(1).join(".");
              }
            }

            // Remove status classes
            $(this).removeClass("disabled completed in-progress");

            // Find the corresponding screen progress
            const screenProgress = screenProgressData.find((progress) => {
              const screen = allLessonScreens.find(
                (s) => s.lesson_screen_id === progress.lesson_screen_id
              );
              return screen && screen.screen_number === screenNumber;
            });

            if (screenProgress) {
              if (screenProgress.status === "completed") {
                $(this).addClass("completed");
              } else if (screenProgress.status === "in_progress") {
                $(this).addClass("in-progress");
              } else {
                $(this).addClass("disabled");
              }
            } else {
              $(this).addClass("disabled");
            }
          });

          // Update CSS styles
          if (!document.getElementById("progress-styles")) {
            const styleSheet = document.createElement("style");
            styleSheet.id = "progress-styles";
            styleSheet.innerHTML = `
                        .lesson-item {
                            transition: all 0.2s ease;
                        }
                        .lesson-item.completed {
                            color: #28a745;
                            opacity: 1;
                            cursor: pointer;
                        }
                        .lesson-item.completed i {
                            color: #28a745;
                        }
                        .lesson-item.in-progress {
                            color: var(--maroon);
                            font-weight: 500;
                            opacity: 1;
                            cursor: pointer;
                        }
                        .lesson-item.disabled {
                            opacity: 0.5;
                            cursor: not-allowed !important;
                            pointer-events: none !important;
                            user-select: none;
                        }
                    `;
            document.head.appendChild(styleSheet);
          }
        }

        /**
         * Build module list based on module progress
         */
        function buildModuleList() {
          const moduleList = $(".module-list");
          moduleList.empty();

          moduleProgressData.forEach((module) => {
            const isLocked = isModuleLocked(module.module_number);
            const isModuleCompleted = module.status === "completed";

            let durationText = "";
            if (module.module_title === "Foundations of Futures Thinking") {
              durationText = "2 hours 40minutes";
            } else if (
              module.module_title === "Mapping Change and Building Insight"
            ) {
              durationText = "3 hours 30 minutes";
            } else if (module.module_title === "Creating Strategic Pathways") {
              durationText = "3 hours 30minutes";
            }
            const durationHtml = durationText
              ? `<small class="d-block fw-normal" style="margin-top: 4px;">${durationText}</small>`
              : "";
            // Create module item with collapsible indicator
            const moduleItem = $(`
                        <li class="module-item" id="module-${
                          module.module_number
                        }">
                            <div class="module-header ${
                              isLocked
                                ? "locked"
                                : isModuleCompleted
                                ? "completed"
                                : module.status === "in_progress"
                                ? "active"
                                : ""
                            }">
                                <i class="fas ${
                                  isLocked
                                    ? "fa-lock"
                                    : isModuleCompleted
                                    ? "fa-check-circle"
                                    : "fa-book"
                                }"></i>
                                <div class="flex-grow-1">
                                  <span>${module.module_title}</span>
                                  ${durationHtml}
                                </div>
                                <i class="fas fa-chevron-down ms-auto"></i>
                                ${
                                  isModuleCompleted
                                    ? '<span class="badge bg-success">Completed</span>'
                                    : ""
                                }
                            </div>
                            <ul class="lesson-list" id="module-${
                              module.module_number
                            }-lessons" style="display: none;">
                            </ul>
                        </li>
                    `);

            moduleList.append(moduleItem);

            // Add lesson items for this module
            const lessonList = $(`#module-${module.module_number}-lessons`);

            // Get all lesson screens for this module
            let moduleScreens = [];

            // If this is module 1, include the intro video (screen_number = "1")
            if (module.module_number === 1) {
              const introScreen = allLessonScreens.find(
                (screen) => screen.screen_number === "1"
              );
              if (introScreen) {
                moduleScreens.push(introScreen);
              }
            }

            // Add all other screens for this module
            const otherScreens = allLessonScreens.filter((screen) => {
              // Skip the intro screen if already added
              if (screen.screen_number === "1") return false;

              // Check if screen belongs to this module
              const parts = screen.screen_number.split(".");
              if (parts.length > 0) {
                const moduleNum = parseInt(parts[0]);
                return moduleNum === module.module_number;
              }
              return false;
            });

            // Combine all screens for this module
            moduleScreens = moduleScreens.concat(otherScreens);

            // Add each screen as a lesson item
            moduleScreens.forEach((screen) => {
              // Check if this is a video screen
              const isVideo = screen.screen_number.includes("-video");

              // Extract the base screen number without the -video suffix
              const baseScreenNumber = isVideo
                ? screen.screen_number.replace("-video", "")
                : screen.screen_number;
              const screenParts = baseScreenNumber.split(".");
              let screenId;

              // Generate a unique ID based on screen number format
              if (screenParts.length === 2) {
                // Format: 1.1, 1.2, etc.
                screenId = `screen-${screenParts[0]}-${screenParts[1]}${
                  isVideo ? "-video" : ""
                }`;
              } else if (screenParts.length === 3) {
                // Format: 1.1.1, 1.1.2, etc.
                screenId = `screen-${screenParts[0]}-${screenParts[1]}-${
                  screenParts[2]
                }${isVideo ? "-video" : ""}`;
              } else {
                // Format: 1, 2, etc.
                screenId = `screen-${baseScreenNumber}${
                  isVideo ? "-video" : ""
                }`;
              }

              // Create lesson item with appropriate icon based on content type
              const lessonItem = $(`
                            <li class="lesson-item ${
                              isModuleCompleted
                                ? "completed"
                                : screen.status === "completed"
                                ? "completed"
                                : screen.status === "in_progress"
                                ? "in-progress"
                                : ""
                            }" id="${screenId}">
                                <i class="fas ${
                                  isModuleCompleted
                                    ? "fa-check-circle"
                                    : isVideo
                                    ? "fa-video"
                                    : screen.status === "completed"
                                    ? "fa-check-circle"
                                    : "fa-file-alt"
                                }"></i>
                                <span>${
                                  screen.screen_title ||
                                  `Screen ${screen.screen_number}`
                                }${isVideo ? " (Video)" : ""}</span>
                            </li>
                        `);

              lessonList.append(lessonItem);
            });
          });
        }
        function selectModule(moduleNumber) {
          // Don't hide all lesson lists as we want to allow multiple modules to be expanded
          // $('.lesson-list').hide();

          // Remove active class from all modules
          $(".module-item").removeClass("active");
          $(".module-header").removeClass("active");

          // Add active class to selected module
          $(`#module-${moduleNumber}`).addClass("active");
          $(`#module-${moduleNumber} .module-header`).addClass("active");

          // Show lessons for selected module if not already visible
          if (!$(`#module-${moduleNumber}-lessons`).is(":visible")) {
            $(`#module-${moduleNumber}-lessons`).show();
            $(
              `#module-${moduleNumber} .module-header .fa-chevron-down`
            ).addClass("fa-chevron-up");
          }

          // Set current module progress
          currentModuleProgress = moduleProgressData.find(
            (module) => module.module_number === moduleNumber
          );

          // Update lesson screen access
          updateLessonScreenAccess();

          // Update progress UI
          updateProgressUI();
        }

        /**
         * Display lesson screen content
         */
        function displayLessonScreen(lessonScreen) {
          const contentContainer = $(".content-container");

          // Scroll window to top
          window.scrollTo(0, 0);

          // Update title
          // Check if it's a video by examining the screen_number suffix
          const isVideo =
            lessonScreen.screen_number &&
            lessonScreen.screen_number.includes("-video");

          if (isVideo && !lessonScreen.screen_title) {
            // If it's a Cloudinary video without a title, use "Video" as the default title
            $(".content-title").text(`Video ${lessonScreen.screen_number}`);
          } else {
            // Otherwise use the screen title or a default
            $(".content-title").text(
              lessonScreen.screen_title ||
                `Screen ${lessonScreen.screen_number}`
            );
          }

          // Update duration in the header
          const durationSpan = $(".content-header .content-duration");
          if (lessonScreen.screen_duration) {
            durationSpan.text(`${lessonScreen.screen_duration} min`);
            durationSpan.show();
          } else {
            durationSpan.hide();
          }

          // Create content HTML
          let contentHtml = "";

          if (lessonScreen.screen_description) {
            contentHtml += `<p class="lead">${lessonScreen.screen_description}</p>`;
          }

          if (
            lessonScreen.screen_url &&
            lessonScreen.screen_url.includes("youtube")
          ) {
            // Display YouTube video
            const videoId =
              lessonScreen.screen_url.split("v=")[1] ||
              lessonScreen.screen_url.split("/").pop();
            contentHtml += `
                        <div class="video-content mb-4">
                            <iframe width="100%" height="100%" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>
                        </div>
                    `;
          } else if (
            lessonScreen.screen_url &&
            lessonScreen.screen_url.includes("cloudinary")
          ) {
            // Check if it's a video based on URL or screen number
            const isVideo = 
              (lessonScreen.screen_number && lessonScreen.screen_number.includes("-video")) ||
              lessonScreen.screen_url.match(/\.(mp4|webm|mov)$/i);

            if (isVideo) {
              // Display video player for video
              contentHtml += `
                            <div class="video-container mb-4">
                                <video controls controlsList="nodownload" playsinline>
                                    <source src="${lessonScreen.screen_url}" type="video/mp4">
                                    <source src="${lessonScreen.screen_url}" type="video/webm">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle"></i> <strong>Important:</strong> You must watch the entire video before continuing.
                            </div>
                            <div class="video-progress-indicator mt-2 text-muted">
                                <small><i class="fas fa-clock"></i> Video completion status: <span id="video-status-${lessonScreen.screen_number}">Not started</span></small>
                            </div>
                        `;

              // Set up video event listeners
              setTimeout(() => {
                const videoElement = document.querySelector('.video-container video');
                if (videoElement) {
                  videoElement.addEventListener('loadstart', function() {
                    this.classList.add('loading');
                  });
                  
                  videoElement.addEventListener('canplay', function() {
                    this.classList.remove('loading');
                  });

                  videoElement.addEventListener("play", function () {
                    $(`#video-status-${lessonScreen.screen_number}`).text("In progress");
                  });

                  videoElement.addEventListener("ended", function () {
                    $(`#video-status-${lessonScreen.screen_number}`).text("Completed");
                    $(".btn-continue").prop("disabled", false);
                  });

                  // Add error handling
                  videoElement.addEventListener('error', function() {
                    console.error('Video error:', this.error);
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'alert alert-danger mt-3';
                    errorDiv.innerHTML = `
                      <i class="fas fa-exclamation-circle"></i> Error loading video. 
                      Please try refreshing the page or contact support if the problem persists.
                    `;
                    this.parentElement.appendChild(errorDiv);
                  });
                }
              }, 100);
            } else {
              // Display image
              contentHtml += `
                            <div class="image-content mb-4">
                                <img src="${lessonScreen.screen_url}" class="img-fluid" alt="${lessonScreen.screen_title}">
                            </div>
                        `;
            }
          }

          if (lessonScreen.screen_content) {
            // Parse content - could be a string or JSON
            let content;
            if (typeof lessonScreen.screen_content === "string") {
              try {
                content = JSON.parse(lessonScreen.screen_content);
              } catch (e) {
                content = lessonScreen.screen_content;
              }
            } else {
              content = lessonScreen.screen_content;
            }

            contentHtml += '<div class="lesson-content mb-4">';

            // Format content with proper indentation for sub-arrays
            if (Array.isArray(content)) {
              contentHtml += formatArrayContent(content, 0);
            } else if (typeof content === "string") {
              contentHtml += `<p>${content}</p>`;
            }

            contentHtml += "</div>";
          }

          // Update content body
          $(".content-body").html(contentHtml);

          // Update navigation buttons
          updateNavigationButtons(lessonScreen.screen_number, isVideo);

          // Start assessment progress checking
          checkAssessmentProgress();
        }

        /**
         * Format array content with proper indentation for sub-arrays
         */
        function formatArrayContent(arr, level) {
          let html = level === 0 ? "" : "<ul>";

          arr.forEach((item) => {
            if (Array.isArray(item)) {
              // Sub-array - next indentation level
              html += formatArrayContent(item, level + 1);
            } else {
              if (level === 0) {
                html += `<p>${item}</p>`;
              } else {
                html += `<li>${item}</li>`;
              }
            }
          });

          html += level === 0 ? "" : "</ul>";
          return html;
        }

        /**
         * Display video content
         */
        function displayVideoContent(videoId) {
          const contentContainer = $(".content-container");

          // Scroll window to top
          window.scrollTo(0, 0);

          let videoUrl;
          let videoTitle;

          // First check if the videoId itself has the -video suffix
          const hasVideoSuffix = videoId && videoId.includes("-video");

          // Then check if there's a corresponding lesson screen
          const matchingScreen = allLessonScreens.find((screen) => {
            // If videoId already has -video suffix, match it exactly
            if (hasVideoSuffix) {
              return screen.screen_number === videoId;
            }
            // Otherwise check if there's a screen with videoId + -video suffix
            return (
              screen.screen_number === `${videoId}-video` ||
              screen.screen_number === videoId
            );
          });

          if (matchingScreen && matchingScreen.screen_url) {
            // Use the Cloudinary URL directly
            videoUrl = matchingScreen.screen_url;
            videoTitle = matchingScreen.screen_title || `Video ${videoId}`;
          } else if (videoId === "intro") {
            // Try to find the intro video in lesson screens
            const introScreen = allLessonScreens.find(
              (screen) => screen.screen_number === "1"
            );
            if (introScreen && introScreen.screen_url) {
              videoUrl = introScreen.screen_url;
            } else {
              // Fallback to default
              videoUrl =
                "https://res.cloudinary.com/dwn5t3o4j/video/upload/v1748185804/1_Introduction_to_Futures_Thinking_egkgxg.mp4";
            }
            videoTitle = "Welcome to Futures Thinking";
          } else {
            // Fallback to Cloudinary URLs with a naming pattern
            console.warn(
              `No direct mapping found for video ${videoId}, using Cloudinary URL pattern`
            );
            videoUrl = `https://res.cloudinary.com/dwn5t3o4j/video/upload/v1748185804/${videoId}_Lesson_Video.mp4`;
            videoTitle = `Lesson ${videoId}`;
          }

          // Update title
          $(".content-title").text(videoTitle);

          // Create video HTML
          const contentHtml = `
                    <div class="video-container">
                        <video controls class="w-100" id="${videoId}-video">
                            <source src="${videoUrl}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle"></i> <strong>Important:</strong> You must watch the entire video before the "Continue" button will be enabled.
                    </div>
                    <div class="video-progress-indicator mt-2 text-muted">
                        <small><i class="fas fa-clock"></i> Video completion status: <span id="video-status-${videoId}">Not started</span></small>
                    </div>
                `;

          // Update content body
          $(".content-body").html(contentHtml);

          // Set up video event listeners
          const video = document.getElementById(`${videoId}-video`);
          if (video) {
            video.addEventListener("play", function () {
              $(`#video-status-${videoId}`).text("In progress");
            });

            video.addEventListener("ended", function () {
              $(`#video-status-${videoId}`).text("Completed");
              $(".btn-continue").prop("disabled", false);
            });
          }

          // Update navigation buttons
          updateNavigationButtons(videoId);
        }

        /**
         * Update navigation buttons based on current content
         */
        function updateNavigationButtons(currentId) {
          const btnBack = $(".btn-back");
          const btnContinue = $(".btn-continue");

          // Find current lesson item
          const currentItem = $(`.lesson-item.active`);

          // Check if the current screen is already completed
          const isCurrentScreenCompleted = currentItem.hasClass("completed");

          // If the screen is completed, disable the continue button and exit
          if (isCurrentScreenCompleted) {
            btnContinue.prop("disabled", true);
            return; // Stop further processing
          }

          // Get current module number
          const currentModuleNumber = parseInt(
            currentItem.closest(".module-item").attr("id").split("-")[1]
          );

          // Get previous and next items, considering module boundaries
          let prevItem = currentItem.prev(".lesson-item");
          let nextItem = currentItem.next(".lesson-item");

          // If there's no next item in current module, check the next module
          if (!nextItem.length) {
            const nextModuleNumber = currentModuleNumber + 1;
            const nextModule = $(`#module-${nextModuleNumber}`);
            if (nextModule.length) {
              nextItem = nextModule.find(".lesson-list .lesson-item:first");
            }
          }

          // Enable/disable back button
          if (prevItem.length) {
            btnBack.prop("disabled", false);
            btnBack.off("click").on("click", function () {
              prevItem.click();
            });
          } else {
            btnBack.prop("disabled", true);
          }

          // For the last screen (no next item), enable continue button to allow completion
          if (!nextItem.length) {
            btnContinue.prop("disabled", false);
            btnContinue.off("click").on("click", function () {
              const currentScreenNumber = getScreenNumberFromId(currentId);

              // On the last screen, we only mark this screen as complete,
              // then update the module progress percentage without marking the module itself as "completed".
              // The assessment modal will then be triggered.
              updateLessonScreenProgress(
                currentScreenNumber,
                "completed",
                100,
                function () {
                  // Update UI to reflect completion of the lesson
                  currentItem.addClass("completed");
                  if (currentItem.find("i").length) {
                    currentItem
                      .find("i")
                      .removeClass("fa-file-alt fa-video in-progress")
                      .addClass("fa-check-circle");
                  }
                  // Update progress data in memory
                  const screenProgress = screenProgressData.find(
                    (progress) => {
                      const screen = allLessonScreens.find(
                        (s) =>
                          s.lesson_screen_id ===
                          progress.lesson_screen_id
                      );
                      return (
                        screen &&
                        screen.screen_number === currentScreenNumber
                      );
                    }
                  );
                  if (screenProgress) {
                    screenProgress.status = "completed";
                    screenProgress.progress_percentage = 100;
                  }

                  // Recalculate module progress, but don't mark as complete
                  updateModuleProgress();

                  // Disable continue button after action
                  btnContinue.prop("disabled", true);

                  // Trigger assessment check
                  checkAssessmentProgress();
                }
              );
            });
          } else {
            // For non-last screens
              // For videos with tracking, disable the continue button until the video is finished.
              // For other content, the button is enabled.
              const lessonScreen = allLessonScreens.find(
                (screen) => screen.screen_number === currentId
              );

              let isTrackableVideo = false;
              if (
                lessonScreen &&
                lessonScreen.screen_url &&
                lessonScreen.screen_url.includes("cloudinary")
              ) {
                const isVideoByUrl =
                  lessonScreen.screen_url.match(/\.(mp4|webm|mov)$/i);
                const isVideoByScreenNumber =
                  lessonScreen.screen_number &&
                  lessonScreen.screen_number.includes("-video");
                if (isVideoByUrl || isVideoByScreenNumber) {
                  isTrackableVideo = true;
                }
              }

              if (isTrackableVideo) {
                btnContinue.prop("disabled", true);
              } else {
                btnContinue.prop("disabled", false);
              }

              btnContinue.off("click").on("click", function () {
                // Get current screen progress ID and next screen ID
                const currentScreenNumber = currentId;
                const nextScreenNumber = getScreenNumberFromId(
                  nextItem.attr("id")
                );

                // First update the database (don't wait for callback to update UI)
                // This ensures the UI updates happen immediately

                // Immediately mark current item as completed in the UI
                currentItem.addClass("completed");
                if (currentItem.find("i").length) {
                  currentItem
                    .find("i")
                    .removeClass("fa-file-alt fa-video")
                    .addClass("fa-check-circle");
                }

                // Find the screen element in the sidebar
                const sidebarItem = $(`.lesson-item[id*="${currentId}"]`);
                if (sidebarItem.length) {
                  sidebarItem.addClass("completed");
                  if (sidebarItem.find("i").length) {
                    sidebarItem
                      .find("i")
                      .removeClass("fa-file-alt fa-video")
                      .addClass("fa-check-circle");
                  }
                }

                // First, mark all in-progress screens as completed
                const resetInProgressScreens = function (callback) {
                  // Get all current in-progress screen progress items
                  const currentInProgressScreens = screenProgressData.filter(
                    (progress) =>
                      progress.status === "in_progress" &&
                      getScreenNumberFromId(currentId) !==
                        progress.screen_number
                  );

                  if (currentInProgressScreens.length === 0) {
                    if (callback) callback();
                    return;
                  }

                  // Keep track of how many screens have been processed
                  let processedCount = 0;

                  // Update each in-progress screen to completed
                  currentInProgressScreens.forEach((screen) => {
                    // Find the lesson screen for this progress
                    const lessonScreen = allLessonScreens.find(
                      (s) => s.lesson_screen_id === screen.lesson_screen_id
                    );
                    if (lessonScreen) {
                      // Mark all other in-progress screens as completed
                      updateLessonScreenProgress(
                        lessonScreen.screen_number,
                        "completed",
                        100,
                        function () {
                          processedCount++;
                          if (
                            processedCount ===
                              currentInProgressScreens.length &&
                            callback
                          ) {
                            callback();
                          }
                        }
                      );
                    } else {
                      processedCount++;
                      if (
                        processedCount === currentInProgressScreens.length &&
                        callback
                      ) {
                        callback();
                      }
                    }
                  });
                };

                // First reset all in-progress screens, then update current and next
                resetInProgressScreens(function () {
                  // Update current screen to completed
                  updateLessonScreenProgress(
                    currentScreenNumber,
                    "completed",
                    100,
                    function () {
                      // Check if we're moving to a new module
                      const nextModuleNumber = nextItem.length
                        ? parseInt(
                            nextItem
                              .closest(".module-item")
                              .attr("id")
                              .split("-")[1]
                          )
                        : null;
                      const currentModuleNumber = parseInt(
                        currentItem
                          .closest(".module-item")
                          .attr("id")
                          .split("-")[1]
                      );

                      // If we're moving to a new module
                      if (nextModuleNumber !== currentModuleNumber) {
                        // Mark current module as completed with 100%
                        if (currentModuleProgress) {
                          currentModuleProgress.status = "completed";
                          currentModuleProgress.progress_percentage = 100;

                          // Update module progress in database
                          fetch(
                            `https://foresite-backend-deployment-qspo9z.laravel.cloud/api/v1/module-progress/${currentModuleProgress.progress_id}`,
                            {
                              method: "PUT",
                              headers: {
                                "Content-Type": "application/json",
                              },
                              body: JSON.stringify({
                                status: "completed",
                                progress_percentage: 100,
                              }),
                            }
                          )
                            .then((response) => response.json())
                            .then(() => {
                              // Select the next module
                              selectModule(nextModuleNumber);

                              // Enable and highlight next item
                              nextItem
                                .removeClass("disabled")
                                .addClass("in-progress");

                              // Find the next screen element in the sidebar
                              const nextSidebarItem = $(
                                `.lesson-item[id*="${nextItem.attr("id")}"]`
                              );
                              if (nextSidebarItem.length) {
                                nextSidebarItem
                                  .removeClass("disabled")
                                  .addClass("in-progress");
                              }

                              // Update the next screen progress status
                              updateLessonScreenProgress(
                                nextScreenNumber,
                                "in_progress",
                                50,
                                function () {
                                  // After progress is updated, navigate to next screen
                                  nextItem.click();

                                  // Update module progress
                                  updateModuleProgress();
                                }
                              );
                            })
                            .catch((error) => {
                              console.error(
                                "Error updating module progress:",
                                error
                              );
                            });
                        }
                      } else {
                        // Same module, just move to next screen
                        // Enable and highlight next item
                        nextItem
                          .removeClass("disabled")
                          .addClass("in-progress");

                        // Find the next screen element in the sidebar
                        const nextSidebarItem = $(
                          `.lesson-item[id*="${nextItem.attr("id")}"]`
                        );
                        if (nextSidebarItem.length) {
                          nextSidebarItem
                            .removeClass("disabled")
                            .addClass("in-progress");
                        }

                        // Update the next screen progress status
                        updateLessonScreenProgress(
                          nextScreenNumber,
                          "in_progress",
                          50,
                          function () {
                            // After progress is updated, navigate to next screen
                            nextItem.click();

                            // Update module progress
                            updateModuleProgress();
                          }
                        );
                      }
                    }
                  );
                });
              });
            }
        }

        /**
         * Extract screen number from element ID
         */
        function getScreenNumberFromId(elementId) {
          if (!elementId) {
            return "1"; // Default to first screen if ID is missing
          }

          console.log("Extracting screen number from ID:", elementId);
          const parts = elementId.split("-");

          // Handle different element ID formats
          if (parts[0] === "screen" || parts[0] === "video") {
            // Check if it's a video screen (last part is 'video')
            const isVideo = parts[parts.length - 1] === "video";

            if (isVideo) {
              // For video screens, combine the middle parts with dot, then add -video
              // Example: screen-2-1-video becomes 2.1-video
              return `${parts.slice(1, -1).join(".")}-video`;
            } else {
              // For regular screens
              if (parts.length === 3) {
                // Handle formats like 'screen-1-2' -> 1.2
                return `${parts[1]}.${parts[2]}`;
              } else if (parts.length === 4) {
                // Handle formats like 'screen-3-2-1' -> 3.2.1
                return `${parts[1]}.${parts[2]}.${parts[3]}`;
              } else {
                return parts[1];
              }
            }
          }

          console.log("No screen number mapping for ID:", elementId);
          return "1.1"; // Default to first content screen if no mapping
        }

        // Add new functions for assessment handling
        let assessmentCheckInterval;

        /**
         * Check assessment progress for completed modules
         */
        function checkAssessmentProgress() {
          // Get user data from session storage
          const userData = JSON.parse(sessionStorage.getItem("user"));
          if (!userData) {
            console.log("Missing user data");
            return;
          }

          console.log("Checking assessment progress");

          fetch(`https://foresite-backend-deployment-qspo9z.laravel.cloud/api/v1/users/${userData.user_id}/assessment-progress`)
            .then((response) => response.json())
            .then((data) => {
              console.log("Assessment progress API response:", data);

              if (!data || !data.data) {
                console.log("No assessment data received");
                return;
              }

              // Find a module that is completed but its assessment is not started
              const completedModuleAssessment = data.data.find(progress => 
                progress.module_progress && 
                progress.module_progress.status === "completed" &&
                progress.status === "not_started"
              );

              console.log("Found completed module with not started assessment:", completedModuleAssessment);

              if (completedModuleAssessment) {
                const moduleNumber = completedModuleAssessment.module_progress.module_number;
                console.log("Showing modal for completed module:", moduleNumber);

                // Update modal content with specific module information
                document.getElementById('assessmentModalLabel').textContent = 
                  `Module ${moduleNumber} Assessment Available`;
                
                document.querySelector('#assessmentModal .modal-body').innerHTML = `
                  <p>You have completed Module ${moduleNumber}: ${completedModuleAssessment.module_progress.module_title}!</p>
                  <p>The module assessment "${completedModuleAssessment.assessment.assessment_title}" is now available.</p>
                  <p>Please proceed to the assessment page to complete your evaluation.</p>
                `;

                // Show the modal
                if (assessmentModal) {
                  assessmentModal.show();
                  console.log("Modal shown");
                } else {
                  console.log("Modal instance not found");
                }
              } else {
                console.log("No completed modules with pending assessments found");
                // Hide modal if it's showing
                if (assessmentModal) {
                  assessmentModal.hide();
                }
              }
            })
            .catch((error) => {
              console.error("Error checking assessment progress:", error);
            });
        }

        // Check when page loads
        $(document).ready(function() {
          checkAssessmentProgress();
        });

        // Modify displayLessonScreen to check when content changes
        const originalDisplayLessonScreen = displayLessonScreen;
        displayLessonScreen = function(lessonScreen) {
          originalDisplayLessonScreen(lessonScreen);
          checkAssessmentProgress();
        };

        // Cloudinary configuration
        const CLOUDINARY_CONFIG = {
            cloudName: 'dwn5t3o4j',
            apiKey: '214461813776441',
            apiSecret: '-3Lake60UIDCJSt7eugmk_-CRIM'
        };

        // Function to fetch videos from Cloudinary
        async function fetchCloudinaryVideos() {
            try {
                const timestamp = Math.round((new Date).getTime()/1000);
                const folder = 'lesson_images';
                
                // Generate signature
                const signatureStr = `folder=${folder}&timestamp=${timestamp}${CLOUDINARY_CONFIG.apiSecret}`;
                const signature = CryptoJS.SHA1(signatureStr).toString();
                
                const params = new URLSearchParams({
                    cloud_name: CLOUDINARY_CONFIG.cloudName,
                    api_key: CLOUDINARY_CONFIG.apiKey,
                    folder: folder,
                    resource_type: 'video',
                    timestamp: timestamp,
                    signature: signature
                });

                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/resources/video?${params}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch videos from Cloudinary');
                }

                const data = await response.json();
                return data.resources;
            } catch (error) {
                console.error('Error fetching Cloudinary videos:', error);
                return [];
            }
        }

        // Function to display video content
        async function displayVideoContent(videoId) {
            try {
                // Fetch videos from Cloudinary
                const cloudinaryVideos = await fetchCloudinaryVideos();
                
                // Find the matching video
                const video = cloudinaryVideos.find(v => v.public_id.includes(videoId));
                
                if (video) {
                    // Update content with video player
                    const contentHtml = `
                        <div class="video-container mb-4">
                            <video controls controlsList="nodownload" playsinline>
                                <source src="${video.secure_url}" type="video/mp4">
                                <source src="${video.secure_url}" type="video/webm">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle"></i> <strong>Important:</strong> You must watch the entire video before continuing.
                        </div>
                        <div class="video-progress-indicator mt-2 text-muted">
                            <small><i class="fas fa-clock"></i> Video completion status: <span id="video-status-${videoId}">Not started</span></small>
                        </div>
                    `;

                    $(".content-body").html(contentHtml);
                    
                    // Set up video event listeners
                    setTimeout(() => {
                        const videoElement = document.querySelector('.video-container video');
                        if (videoElement) {
                            videoElement.addEventListener('loadstart', function() {
                                this.classList.add('loading');
                            });
                            
                            videoElement.addEventListener('canplay', function() {
                                this.classList.remove('loading');
                            });

                            videoElement.addEventListener("play", function () {
                                $(`#video-status-${videoId}`).text("In progress");
                            });

                            videoElement.addEventListener("ended", function () {
                                $(`#video-status-${videoId}`).text("Completed");
                                $(".btn-continue").prop("disabled", false);
                            });

                            // Add error handling
                            videoElement.addEventListener('error', function() {
                                console.error('Video error:', this.error);
                                const errorDiv = document.createElement('div');
                                errorDiv.className = 'alert alert-danger mt-3';
                                errorDiv.innerHTML = `
                                  <i class="fas fa-exclamation-circle"></i> Error loading video. 
                                  Please try refreshing the page or contact support if the problem persists.
                                `;
                                this.parentElement.appendChild(errorDiv);
                            });
                        }
                    }, 100);
                } else {
                    throw new Error('Video not found');
                }
            } catch (error) {
                console.error('Error displaying video:', error);
                $(".content-body").html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> Failed to load video. Please try again later.
                    </div>
                `);
            }
        }

        /**
         * Checks if a module should be locked based on the previous module's assessment score.
         */
        function isModuleLocked(moduleNumber) {
          if (moduleNumber === 1) {
            return false; // Module 1 is never locked
          }

          const prerequisiteModuleNumber = moduleNumber - 1;

          // Find the assessment progress for the prerequisite module
          const prereqAssessmentProgress = assessmentProgressData.find(ap => 
            ap.assessment && ap.assessment.module_number === prerequisiteModuleNumber
          );

          // If there's no assessment progress record for the prerequisite, lock the module.
          if (!prereqAssessmentProgress) {
            console.log(`Module ${moduleNumber} is locked because no assessment progress was found for module ${prerequisiteModuleNumber}.`);
            return true;
          }

          // If the assessment for the prerequisite module is not completed, lock the module.
          if (prereqAssessmentProgress.status !== 'completed') {
            console.log(`Module ${moduleNumber} is locked because the assessment for module ${prerequisiteModuleNumber} is not completed.`);
            return true;
          }

          // Find the score for that assessment progress
          const score = scoresData.find(s => s.module_assessment_progress_id === prereqAssessmentProgress.assessment_progress_id);

          // If there is no score or the score is not passing (<= 2), lock the module.
          if (!score || score.score <= 2) {
            console.log(`Module ${moduleNumber} is locked because the assessment for module ${prerequisiteModuleNumber} was not passed (Score: ${score ? score.score : 'N/A'}).`);
            return true;
          }

          // If all checks pass, the module is unlocked.
          return false;
        }
      });
    </script>
  </body>
</html>
