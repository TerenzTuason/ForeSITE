<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Courses Management - ForeSITE</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- CryptoJS for Cloudinary signature -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --maroon: #800000;
            --gold: #FFB81C;
            --light-gray: #f5f5f5;
            --dark-gray: #333;
            --border-radius: 8px;
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-gray);
            min-height: 100vh;
        }

        /* Navigation Styles */
        .navbar {
            background: var(--maroon);
            padding: 1rem 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .navbar-brand {
            color: white !important;
            font-weight: 600;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .navbar-brand img {
            height: 35px;
        }

        .nav-link {
            color: rgba(255,255,255,0.9) !important;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 0.75rem 1.5rem !important;
            border-radius: 50px;
            margin: 0 0.5rem;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--gold) !important;
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }

        .nav-link.btn-logout {
            background-color: var(--gold);
            color: var(--maroon) !important;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .nav-link.btn-logout:hover {
            background-color: #fff;
            transform: translateY(-2px);
        }

        /* Course Styles */
        .courses-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .section-title {
            color: var(--maroon);
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-add-course {
            background-color: var(--maroon);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-add-course:hover {
            background-color: #600000;
            color: white;
            transform: translateY(-2px);
        }

        .course-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .course-header {
            background: var(--maroon);
            color: white;
            padding: 1.5rem;
            position: relative;
        }

        .course-id {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--gold);
            color: var(--maroon);
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .course-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .course-description {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .course-body {
            padding: 1.5rem;
        }

        .objectives-list {
            padding-left: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .objectives-list li {
            margin-bottom: 0.5rem;
            color: var(--dark-gray);
        }

        .modules-container {
            margin-top: 1.5rem;
        }

        .module-card {
            background: var(--light-gray);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .module-card:hover {
            background: #eaeaea;
            transform: translateY(-2px);
        }

        .module-title {
            font-weight: 600;
            color: var(--maroon);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }

        .module-number {
            background: var(--maroon);
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            margin-right: 0.75rem;
        }

        .module-focus {
            font-size: 0.9rem;
            color: var(--dark-gray);
            margin-left: 2.5rem;
        }

        .course-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background: #f9f9f9;
            border-top: 1px solid #eee;
        }

        .btn-edit, .btn-delete {
            padding: 0.4rem 1rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .btn-edit {
            background: var(--gold);
            color: var(--maroon);
            border: none;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
        }

        .btn-edit:hover, .btn-delete:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .spinner-border {
            color: var(--maroon);
            width: 3rem;
            height: 3rem;
        }

        @media (max-width: 768px) {
            .section-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .course-id {
                position: static;
                display: inline-block;
                margin-bottom: 0.5rem;
            }
            
            .course-header {
                padding: 1rem;
            }
        }

        /* Active tab styles */
        .nav-tabs .nav-link.active {
            background-color: #f8f9fa !important;
            border-bottom: 0 !important;
            color: var(--maroon) !important;
            font-weight: bold;
            border-top: 3px solid var(--maroon) !important;
        }
        
        /* Inactive tab styles */
        .nav-tabs .nav-link:not(.active) {
            background-color: #e9ecef !important;
            color: #495057 !important;
        }
        
        /* Hover effect for tabs */
        .nav-tabs .nav-link:hover:not(.active) {
            background-color: #dee2e6 !important;
            border-color: #dee2e6 #dee2e6 #fff;
        }
        
        /* Active pill styles */
        .nav-pills .nav-link.active {
            background-color: #0d6efd !important;
            color: white !important;
        }
        
        /* Inactive pill styles */
        .nav-pills .nav-link:not(.active) {
            background-color: #f8f9fa !important;
            color: black !important;
            border: 1px solid #dee2e6 !important;
        }
        
        /* Hover effect for pills */
        .nav-pills .nav-link:hover:not(.active) {
            background-color: #e9ecef !important;
        }
        
        /* Main tab content container */
        .tab-content {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-top: none;
            padding: 1rem;
            border-radius: 0 0 0.25rem 0.25rem;
        }

        /* Custom styling for learning style tabs */
        .nav-pills {
            gap: 8px;
        }
        
        .nav-pills .nav-item {
            margin: 0 3px;
        }
        
        .nav-pills .nav-link {
            transition: all 0.2s ease;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .nav-pills .nav-link:hover {
            transform: translateY(-2px);
        }
        
        .nav-pills .nav-link.active {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
        }
        
        /* Style badges */
        .style-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.8rem;
            color: white;
            display: inline-block;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .style-badge-activist {
            background-color: #dc3545;
        }
        
        .style-badge-reflector {
            background-color: #0dcaf0;
        }
        
        .style-badge-theorist {
            background-color: #198754;
        }
        
        .style-badge-pragmatist {
            background-color: #fd7e14;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="#">
                <img src="../assets/logo/pup.png" alt="PUP Logo">
                <span class="d-none d-sm-inline">FORESITE: Admin Portal</span>
                <span class="d-inline d-sm-none">FORESITE</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav align-items-center">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-home me-2"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="users.html">
                            <i class="fas fa-users me-2"></i>Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="progress.html">
                            <i class="fas fa-chart-line me-2"></i>Progress
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="courses.html">
                            <i class="fas fa-book me-2"></i>Courses
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link btn-logout" href="login.html" id="logoutBtn">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="courses-container">
        <div class="section-title">
            <span>Course Management</span>
        </div>
        
        <div id="coursesList">
            <div class="loading-container">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Lesson Screen Modal -->
    <div class="modal fade" id="lessonScreenModal" tabindex="-1" aria-labelledby="lessonScreenModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="lessonScreenModalLabel">Add New Lesson Screen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="lessonScreenForm">
                        <input type="hidden" id="lessonScreenId">
                        <input type="hidden" id="moduleNumber">
                        
                        <div class="mb-3">
                            <label for="screenNumber" class="form-label">Screen Number*</label>
                            <input type="text" class="form-control" id="screenNumber" required 
                                   placeholder="e.g., 1.1, 1.2, etc.">
                            <div class="form-text">Format: [Module].[Screen] (e.g., 1.1 for Module 1, Screen 1)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="screenTitle" class="form-label">Screen Title*</label>
                            <input type="text" class="form-control" id="screenTitle" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="screenDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="screenDescription" rows="3"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="contentType" class="form-label">Content Type</label>
                            <select class="form-select" id="contentType">
                                <option value="text">Text Content</option>
                                <option value="image">Image</option>
                                <option value="video">Video</option>
                            </select>
                        </div>
                        
                        <div id="textContentSection" class="mb-3">
                            <label for="screenContent" class="form-label">Content</label>
                            <textarea class="form-control" id="screenContent" rows="5"></textarea>
                        </div>
                        
                        <div id="urlContentSection" class="mb-3 d-none">
                            <label for="screenUrl" class="form-label">Content URL</label>
                            <input type="url" class="form-control" id="screenUrl" 
                                   placeholder="https://example.com/content" readonly>
                            <div class="form-text">URL will be automatically populated after file upload</div>
                        </div>

                        <div id="uploadSection" class="mb-3 d-none">
                            <label class="form-label">File Upload</label>
                            <input type="file" class="form-control" id="fileUpload" accept=".jpg,.jpeg,.png,.gif,.mp4,.webm,.mov">
                            <div class="form-text" id="uploadHelp">
                                Supported formats:<br>
                                Images: JPG, JPEG, PNG, GIF<br>
                                Videos: MP4, WEBM, MOV
                            </div>
                            <div class="progress mt-2 d-none">
                                <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="screenDuration" class="form-label">Duration</label>
                            <input type="text" class="form-control" id="screenDuration" 
                                   placeholder="e.g., 15 minutes">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveLessonScreen">Save Screen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this lesson screen? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Cloudinary configuration
        const CLOUDINARY_CONFIG = {
            cloudName: 'dwn5t3o4j',
            apiKey: '214461813776441',
            apiSecret: '-3Lake60UIDCJSt7eugmk_-CRIM',
            uploadPreset: 'ml_default'
        };

        // Handle file upload to Cloudinary
        async function uploadToCloudinary(file) {
            const formData = new FormData();
            const contentType = document.getElementById('contentType').value;
            
            // Determine folder based on content type
            const uploadFolder = 'lesson_images'; // Always use lesson_images folder
            const timestamp = Math.round((new Date).getTime()/1000);

            // Build upload params
            formData.append('file', file);
            formData.append('folder', uploadFolder);
            formData.append('timestamp', timestamp);
            
            // Generate signature string
            const signatureStr = `folder=${uploadFolder}&timestamp=${timestamp}${CLOUDINARY_CONFIG.apiSecret}`;
            const signature = CryptoJS.SHA1(signatureStr).toString();
            
            formData.append('signature', signature);
            formData.append('api_key', CLOUDINARY_CONFIG.apiKey);
            
            const progressBar = document.querySelector('.progress');
            const progressBarInner = progressBar.querySelector('.progress-bar');
            progressBar.classList.remove('d-none');
            
            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/auto/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Cloudinary error:', errorData);
                    throw new Error(errorData.error?.message || 'Upload failed');
                }

                const data = await response.json();
                document.getElementById('screenUrl').value = data.secure_url;
                showAlert('success', 'File uploaded successfully!');
                progressBar.classList.add('d-none');
                return data.secure_url;
            } catch (error) {
                console.error('Upload error:', error);
                showAlert('danger', `Error uploading file: ${error.message}`);
                progressBar.classList.add('d-none');
                throw error;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            const userString = sessionStorage.getItem('user');
            if (!userString) {
                window.location.href = 'login.html';
                return;
            }
            
            const user = JSON.parse(userString);
            if (user.role.role_name !== 'admin') {
                alert('Unauthorized access. This area is only for administrators.');
                window.location.href = 'login.html';
                return;
            }
            
            // Fetch courses data and lesson screens
            fetchCourses();
            fetchLessonScreens();
            fetchLearningStyles();
            
            // Logout functionality
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                sessionStorage.removeItem('user');
                window.location.href = 'login.html';
            });
            
            // Add custom CSS for tab styling
            const styleElement = document.createElement('style');
            styleElement.textContent = `
                /* Active tab styles */
                .nav-tabs .nav-link.active {
                    background-color: #f8f9fa !important;
                    border-bottom: 0 !important;
                    color: var(--maroon) !important;
                    font-weight: bold;
                    border-top: 3px solid var(--maroon) !important;
                }
                
                /* Inactive tab styles */
                .nav-tabs .nav-link:not(.active) {
                    background-color: #e9ecef !important;
                    color: #495057 !important;
                }
                
                /* Hover effect for tabs */
                .nav-tabs .nav-link:hover:not(.active) {
                    background-color: #dee2e6 !important;
                    border-color: #dee2e6 #dee2e6 #fff;
                }
                
                /* Active pill styles */
                .nav-pills .nav-link.active {
                    background-color: #0d6efd !important;
                    color: white !important;
                }
                
                /* Inactive pill styles */
                .nav-pills .nav-link:not(.active) {
                    background-color: #f8f9fa !important;
                    border: 1px solid #dee2e6 !important;
                }
                
                /* Hover effect for pills */
                .nav-pills .nav-link:hover:not(.active) {
                    background-color: #e9ecef !important;
                }
                
                /* Main tab content container */
                .tab-content {
                    background-color: #f8f9fa;
                    border: 1px solid #dee2e6;
                    border-top: none;
                    padding: 1rem;
                    border-radius: 0 0 0.25rem 0.25rem;
                }
            `;
            document.head.appendChild(styleElement);

            // Add file input change handler
            document.getElementById('fileUpload').addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const contentType = document.getElementById('contentType').value;
                const isImage = contentType === 'image';
                const isVideo = contentType === 'video';

                // Validate file type
                const fileType = file.type.split('/')[0];
                if ((isImage && fileType !== 'image') || (isVideo && fileType !== 'video')) {
                    showAlert('danger', `Please select a ${contentType} file.`);
                    this.value = '';
                    return;
                }

                try {
                    await uploadToCloudinary(file);
                } catch (error) {
                    console.error('Error during upload:', error);
                }
            });

            // Modify content type change handler
            document.getElementById('contentType').addEventListener('change', function(e) {
                const textSection = document.getElementById('textContentSection');
                const urlSection = document.getElementById('urlContentSection');
                const uploadSection = document.getElementById('uploadSection');
                const fileInput = document.getElementById('fileUpload');
                
                switch(e.target.value) {
                    case 'text':
                        textSection.classList.remove('d-none');
                        urlSection.classList.add('d-none');
                        uploadSection.classList.add('d-none');
                        break;
                    case 'image':
                        textSection.classList.add('d-none');
                        urlSection.classList.remove('d-none');
                        uploadSection.classList.remove('d-none');
                        fileInput.accept = '.jpg,.jpeg,.png,.gif';
                        break;
                    case 'video':
                        textSection.classList.add('d-none');
                        urlSection.classList.remove('d-none');
                        uploadSection.classList.remove('d-none');
                        fileInput.accept = '.mp4,.webm,.mov';
                        break;
                }
            });
        });
        
        // Store data globally
        let lessonScreensData = [];
        let learningStylesData = [];
        let consolidatedCourses = [];
        
        async function fetchLearningStyles() {
            try {
                console.log('Fetching learning styles from API...');
                const response = await fetch('http://127.0.0.1:8000/api/v1/learning-styles');
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch learning styles: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data && data.data) {
                    learningStylesData = data.data;
                    console.log('Loaded learning styles:', learningStylesData);
                } else {
                    console.error('Unexpected API response format for learning styles:', data);
                }
            } catch (error) {
                console.error('Error fetching learning styles:', error);
            }
        }
        
        async function fetchCourses() {
            try {
                console.log('Fetching courses from API...');
                const response = await fetch('http://127.0.0.1:8000/api/v1/courses');
                console.log('API response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch courses: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('API response data:', data);
                
                if (data && data.data) {
                    // Consolidate courses by name
                    consolidateCourses(data.data);
                    displayConsolidatedCourses();
                } else {
                    console.error('Unexpected API response format:', data);
                    throw new Error('Unexpected API response format');
                }
            } catch (error) {
                console.error('Error fetching courses:', error);
                document.getElementById('coursesList').innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        Failed to load courses. Please try again later.<br>
                        Error: ${error.message}
                    </div>
                `;
            }
        }
        
        function consolidateCourses(coursesData) {
            // Group courses by name or a unique identifier
            const courseGroups = {};
            
            coursesData.forEach(course => {
                const courseName = course.name || 'Untitled Course';
                
                if (!courseGroups[courseName]) {
                    courseGroups[courseName] = {
                        name: courseName,
                        description: course.description,
                        objectives: course.objectives,
                        structure: course.structure,
                        styleVersions: [],
                        uniqueModules: new Map() // Use Map to track unique modules
                    };
                }
                
                // Add this learning style version
                courseGroups[courseName].styleVersions.push({
                    course_id: course.course_id,
                    learning_style: course.learning_style,
                    name: course.name,
                    description: course.description
                });
                
                // Add unique modules (if any differences)
                if (course.structure && Array.isArray(course.structure)) {
                    course.structure.forEach(module => {
                        const moduleKey = module.title || 'Untitled Module';
                        if (!courseGroups[courseName].uniqueModules.has(moduleKey)) {
                            courseGroups[courseName].uniqueModules.set(moduleKey, module);
                        }
                    });
                }
            });
            
            // Convert uniqueModules Map to array
            Object.values(courseGroups).forEach(course => {
                course.uniqueModules = Array.from(course.uniqueModules.values());
            });
            
            // Convert to array
            consolidatedCourses = Object.values(courseGroups);
            console.log('Consolidated courses:', consolidatedCourses);
        }
        
        function displayConsolidatedCourses() {
            const coursesContainer = document.getElementById('coursesList');
            
            if (consolidatedCourses.length === 0) {
                coursesContainer.innerHTML = `
                    <div class="alert alert-info" role="alert">
                        No courses available. Click the "Add New Course" button to create one.
                    </div>
                `;
                return;
            }
            
            let coursesHTML = '';
            
            consolidatedCourses.forEach(course => {
                // Generate a unique ID for this course's tabs
                const courseId = 'course-' + Math.random().toString(36).substr(2, 9);
                
                // Create style badges for learning styles
                const styleBadges = course.styleVersions.map(sv => 
                    `<span class="badge bg-primary me-2">${sv.learning_style?.style_name || 'Unknown'}</span>`
                ).join('');
                
                // Create main navigation tabs (Course, Modules, Lesson Screens)
                const mainTabsHTML = `
                    <ul class="nav nav-tabs mb-3" id="${courseId}-main-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active fw-bold" id="${courseId}-course-tab" 
                                data-bs-toggle="tab" 
                                data-bs-target="#${courseId}-course" type="button" role="tab" 
                                aria-controls="${courseId}-course" aria-selected="true"
                                style="background-color: #f8f9fa; border-bottom: 0; color: var(--maroon);">
                                <i class="fas fa-book me-2"></i>Course
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link fw-bold" id="${courseId}-modules-tab" 
                                data-bs-toggle="tab" 
                                data-bs-target="#${courseId}-modules" type="button" role="tab" 
                                aria-controls="${courseId}-modules" aria-selected="false"
                                style="background-color: #e9ecef; color: #495057;">
                                <i class="fas fa-cubes me-2"></i>Modules
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link fw-bold" id="${courseId}-lessons-tab" 
                                data-bs-toggle="tab" 
                                data-bs-target="#${courseId}-lessons" type="button" role="tab" 
                                aria-controls="${courseId}-lessons" aria-selected="false"
                                style="background-color: #e9ecef; color: #495057;">
                                <i class="fas fa-layer-group me-2"></i>Lesson Screens
                            </button>
                        </li>
                    </ul>
                `;
                
                // Create learning style tabs
                const styleTabsHTML = `
                    <ul class="nav nav-pills nav-fill mb-3" id="${courseId}-style-tabs" role="tablist" 
                        style="background-color: #e9ecef; padding: 10px; border-radius: 5px;">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active fw-bold" id="${courseId}-all-tab" 
                                data-bs-toggle="pill" 
                                data-bs-target="#${courseId}-all" type="button" role="tab" 
                                aria-controls="${courseId}-all" aria-selected="true"
                                style="background-color: #0d6efd; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                All Styles
                            </button>
                        </li>
                        ${course.styleVersions.map((styleVersion, index) => {
                            const styleName = styleVersion.learning_style?.style_name || 'Unknown';
                            const styleId = styleName.toLowerCase().replace(/\s+/g, '-');
                            
                            // Assign different colors based on learning style
                            let styleColor, bgColor;
                            if (styleName.toLowerCase() === 'activist') {
                                styleColor = '#dc3545'; // Red
                                bgColor = '#f8d7da';
                            } else if (styleName.toLowerCase() === 'reflector') {
                                styleColor = '#0dcaf0'; // Cyan
                                bgColor = '#d1ecf1';
                            } else if (styleName.toLowerCase() === 'theorist') {
                                styleColor = '#198754'; // Green
                                bgColor = '#d1e7dd';
                            } else if (styleName.toLowerCase() === 'pragmatist') {
                                styleColor = '#fd7e14'; // Orange
                                bgColor = '#fff3cd';
                            } else {
                                styleColor = '#6c757d'; // Default gray
                                bgColor = '#e2e3e5';
                            }
                            
                            return `
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link fw-bold" id="${courseId}-${styleId}-tab" 
                                        data-bs-toggle="pill" 
                                        data-bs-target="#${courseId}-${styleId}" type="button" role="tab" 
                                        aria-controls="${courseId}-${styleId}" aria-selected="false"
                                        style="background-color: ${bgColor}; color: ${styleColor}; border: 2px solid ${styleColor}; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        ${styleName}
                                    </button>
                                </li>
                            `;
                        }).join('')}
                    </ul>
                `;
                
                // Generate objectives HTML
                const objectivesHTML = course.objectives && Array.isArray(course.objectives) 
                    ? course.objectives.map(obj => `<li>${obj}</li>`).join('') 
                    : '<li>No objectives specified</li>';
                
                // Generate modules HTML
                let modulesHTML = '';
                if (course.uniqueModules && course.uniqueModules.length > 0) {
                    course.uniqueModules.forEach((module, moduleIndex) => {
                        // Use moduleIndex + 1 as a fallback module number
                        const moduleNumber = module.module || (moduleIndex + 1);
                        
                        modulesHTML += `
                            <div class="module-card mb-3" data-module-number="${moduleNumber}">
                                <div class="module-title p-3 bg-light rounded">
                                    <span class="module-number bg-maroon text-white rounded-circle d-inline-flex align-items-center justify-content-center me-2" style="width: 30px; height: 30px;">${moduleNumber}</span>
                                    <span class="fw-bold">${module.title || 'Untitled Module'}</span>
                                </div>
                                <div class="module-focus p-3">${module.focus || 'No focus specified'}</div>
                            </div>
                        `;
                    });
                } else {
                    modulesHTML = '<p class="text-muted">No modules available for this course.</p>';
                }
                
                // Create tab content for each learning style
                let styleTabContentsHTML = `
                    <div class="tab-content" id="${courseId}-style-tabContent">
                        <div class="tab-pane fade show active" id="${courseId}-all" role="tabpanel" aria-labelledby="${courseId}-all-tab">
                            <div class="mb-3">
                                ${styleBadges}
                            </div>
                            <div class="style-details bg-light p-3 rounded mb-3">
                                <h4 class="mb-3">Course Overview</h4>
                                <p>${course.description || 'No description provided'}</p>
                            </div>
                        </div>
                `;
                
                // Add tab content for each learning style
                course.styleVersions.forEach((styleVersion) => {
                    const styleName = styleVersion.learning_style?.style_name || 'Unknown';
                    const styleId = styleName.toLowerCase().replace(/\s+/g, '-');
                    
                    styleTabContentsHTML += `
                        <div class="tab-pane fade" id="${courseId}-${styleId}" role="tabpanel" aria-labelledby="${courseId}-${styleId}-tab">
                            <div class="style-details bg-light p-3 rounded mb-3">
                                <h4 class="mb-3">Style: ${styleName}</h4>
                                <p>${styleVersion.description || 'No description provided for this learning style version.'}</p>
                            </div>
                        </div>
                    `;
                });
                
                styleTabContentsHTML += `</div>`;
                
                // Create main tab content sections
                const mainTabContentHTML = `
                    <div class="tab-content" id="${courseId}-main-tabContent">
                        <!-- Course Tab Content -->
                        <div class="tab-pane fade show active" id="${courseId}-course" role="tabpanel" aria-labelledby="${courseId}-course-tab">
                            ${styleTabsHTML}
                            ${styleTabContentsHTML}
                            
                            <h5 class="mt-4">Course Objectives:</h5>
                            <ul class="objectives-list">
                                ${objectivesHTML}
                            </ul>
                        </div>
                        
                        <!-- Modules Tab Content -->
                        <div class="tab-pane fade" id="${courseId}-modules" role="tabpanel" aria-labelledby="${courseId}-modules-tab">
                            <h5 class="mb-3">Course Modules:</h5>
                            <div class="modules-container">
                                ${modulesHTML}
                            </div>
                        </div>
                        
                        <!-- Lesson Screens Tab Content -->
                        <div class="tab-pane fade" id="${courseId}-lessons" role="tabpanel" aria-labelledby="${courseId}-lessons-tab">
                            <h5 class="mb-3">Lesson Screens by Module:</h5>
                            <div class="lesson-screens-by-module">
                                ${course.uniqueModules && course.uniqueModules.length > 0 ? 
                                    course.uniqueModules.map((module, moduleIndex) => {
                                        const moduleNumber = module.module || (moduleIndex + 1);
                                        return `
                                            <div class="module-lesson-screens mb-4">
                                                <div class="module-header p-3 bg-light rounded d-flex justify-content-between align-items-center mb-2">
                                                    <div>
                                                        <span class="badge bg-maroon text-white me-2">${moduleNumber}</span>
                                                        <span class="fw-bold">${module.title || 'Untitled Module'}</span>
                                                    </div>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="toggleModuleLessons('module-${courseId}-${moduleNumber}-lessons')">
                                                        <i class="fas fa-chevron-down"></i>
                                                    </button>
                                                </div>
                                                <div class="module-lessons-container ps-3" id="module-${courseId}-${moduleNumber}-lessons">
                                                    <div class="lesson-screens-list" data-module-number="${moduleNumber}">
                                                        <!-- Will be populated after rendering -->
                                                        <div class="placeholder-text text-muted">Loading lesson screens...</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('') : 
                                    '<p class="text-muted">No modules available to display lesson screens.</p>'
                                }
                            </div>
                        </div>
                    </div>
                `;
                
                // Construct the full course card HTML
                coursesHTML += `
                    <div class="course-card mb-4">
                        <div class="course-header">
                            <h2 class="course-title">${course.name}</h2>
                        </div>
                        <div class="course-body">
                            ${mainTabsHTML}
                            ${mainTabContentHTML}
                            </div>
                    </div>
                `;
            });
            
            coursesContainer.innerHTML = coursesHTML;
            
            // Update modules with lesson screens if data is available
            if (lessonScreensData.length > 0) {
                displayLessonScreensByModuleNumber();
            }
        }
        
        function editSharedCourse(courseName) {
            alert(`Edit shared structure for course: ${courseName}`);
            // This would open a modal to edit the shared course structure
            // Changes would apply to all learning style versions
        }
        
        function editStyleVersion(courseId) {
            alert(`Edit style-specific details for course ID: ${courseId}`);
            // This would open a modal to edit style-specific metadata
        }
        
        function deleteAllStyleVersions(courseName) {
            if (confirm(`Are you sure you want to delete ALL versions of "${courseName}"?`)) {
                alert(`All versions of "${courseName}" would be deleted`);
                // This would delete all style versions of the course
            }
        }
        
        async function fetchLessonScreens() {
            try {
                console.log('Fetching lesson screens from API...');
                const response = await fetch('http://127.0.0.1:8000/api/v1/lesson-screens');
                console.log('Lesson screens API response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch lesson screens: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Lesson screens API response data:', data);
                
                if (data && data.data) {
                    lessonScreensData = data.data;
                    console.log('Loaded lesson screens:', lessonScreensData.length);
                    
                    // After lesson screens are loaded, update the UI if courses are already displayed
                    const coursesContainer = document.getElementById('coursesList');
                    if (!coursesContainer.querySelector('.loading-container')) {
                        displayLessonScreensByModuleNumber();
                    }
                } else {
                    console.error('Unexpected API response format for lesson screens:', data);
                }
            } catch (error) {
                console.error('Error fetching lesson screens:', error);
            }
        }
        
        function toggleModuleLessons(containerId) {
            const container = document.getElementById(containerId);
            const button = container.previousElementSibling.querySelector('button');
            const icon = button.querySelector('i');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
            } else {
                container.style.display = 'none';
                icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
            }
        }
        
        function displayLessonScreensByModuleNumber() {
            console.log('Displaying lesson screens by module number...');
            
            // Group lesson screens by screen_number (assuming first digit is module number)
            const screensByModule = {};
            
            // Helper function to compare screen numbers hierarchically
            function compareScreenNumbers(a, b) {
                const partsA = a.screen_number.toString().split('.');
                const partsB = b.screen_number.toString().split('.');
                
                // Compare each level of hierarchy
                for (let i = 0; i < Math.max(partsA.length, partsB.length); i++) {
                    // If a part doesn't exist, treat it as 0
                    const numA = i < partsA.length ? parseInt(partsA[i]) : 0;
                    const numB = i < partsB.length ? parseInt(partsB[i]) : 0;
                    
                    if (numA !== numB) {
                        return numA - numB;
                    }
                }
                
                // If all parts are equal, shorter numbers come first
                return partsA.length - partsB.length;
            }
            
            lessonScreensData.forEach(screen => {
                // Extract module number from screen number (e.g., "1.1" -> "1")
                let moduleNumber = 1; // Default to module 1
                
                if (screen.screen_number) {
                    const parts = screen.screen_number.toString().split('.');
                    if (parts.length > 0 && !isNaN(parts[0])) {
                        moduleNumber = parseInt(parts[0]);
                    }
                } else if (screen.module_id) {
                    moduleNumber = screen.module_id;
                }
                
                // Initialize array if needed
                if (!screensByModule[moduleNumber]) {
                    screensByModule[moduleNumber] = [];
                }
                
                // Add screen to the module's array
                screensByModule[moduleNumber].push(screen);
            });
            
            // Sort screens within each module
            Object.values(screensByModule).forEach(screens => {
                screens.sort(compareScreenNumbers);
            });
            
            console.log('Grouped and sorted screens by module:', screensByModule);
            
            // Find all lesson-screens-list elements with data-module-number attribute
            const screensLists = document.querySelectorAll('.lesson-screens-list[data-module-number]');
            console.log('Found lesson screen lists:', screensLists.length);
            
            screensLists.forEach(screensList => {
                const moduleNumber = screensList.getAttribute('data-module-number');
                const screens = screensByModule[moduleNumber] || [];
                
                let screensHTML = '';
                
                if (screens.length === 0) {
                    screensHTML = '<p class="text-muted">No lesson screens available for this module.</p>';
                } else {
                    screens.forEach(screen => {
                        // Determine content type based on URL extension
                        let contentType = 'content';
                        let contentIcon = 'fa-file-alt';
                        let contentClass = 'success';
                        
                        if (screen.screen_url) {
                            const url = screen.screen_url.toLowerCase();
                            if (url.endsWith('.mp4') || url.endsWith('.webm') || url.endsWith('.avi') || url.endsWith('.mov')) {
                                contentType = 'video';
                                contentIcon = 'fa-video';
                                contentClass = 'info';
                            } else if (url.endsWith('.jpg') || url.endsWith('.jpeg') || url.endsWith('.png') || url.endsWith('.gif') || url.endsWith('.svg')) {
                                contentType = 'image';
                                contentIcon = 'fa-image';
                                contentClass = 'primary';
                            }
                        }
                        
                        screensHTML += `
                            <div class="lesson-screen-item p-3 mb-2 border-start border-3 border-${contentClass} ps-3 bg-light rounded">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="fw-bold">${screen.screen_number || '?'}: ${screen.screen_title || 'Untitled Screen'}</span>
                                        <span class="badge bg-${contentClass} ms-2 rounded-pill">
                                            <i class="fas ${contentIcon} me-1"></i>${contentType.charAt(0).toUpperCase() + contentType.slice(1)}
                                        </span>
                                    </div>
                                    <div class="btn-group">
              
                                        <button class="btn btn-sm btn-outline-primary" onclick="editLessonScreen(${screen.lesson_screen_id})">
                                            <i class="fas fa-edit me-1"></i>Edit
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteLessonScreen(${screen.lesson_screen_id})">
                                            <i class="fas fa-trash me-1"></i>Delete
                                        </button>
                                    </div>
                                </div>
                                ${screen.screen_description ? `<div class="mt-2">${screen.screen_description}</div>` : ''}
                            </div>
                        `;
                    });
                }
                
                // Add "Add New Screen" button at the top of each module's lesson screen section
                const moduleHeader = screensList.closest('.module-lesson-screens').querySelector('.module-header');
                const addButton = document.createElement('button');
                addButton.className = 'btn btn-sm btn-success';
                addButton.innerHTML = '<i class="fas fa-plus me-1"></i>Add Screen';
                addButton.onclick = () => addLessonScreen(moduleNumber);
                moduleHeader.querySelector('div').appendChild(addButton);

                // Remove any placeholder
                screensList.innerHTML = screensHTML;
            });
        }
        
        // Function to show the add lesson screen modal
        function addLessonScreen(moduleNumber) {
            const modal = new bootstrap.Modal(document.getElementById('lessonScreenModal'));
            document.getElementById('lessonScreenModalLabel').textContent = 'Add New Lesson Screen';
            document.getElementById('lessonScreenForm').reset();
            document.getElementById('moduleNumber').value = moduleNumber;
            document.getElementById('screenNumber').value = `${moduleNumber}.${getNextScreenNumber(moduleNumber)}`;
            modal.show();
        }

        // Function to get the next available screen number for a module
        function getNextScreenNumber(moduleNumber) {
            const moduleScreens = lessonScreensData.filter(screen => {
                const parts = screen.screen_number.toString().split('.');
                return parts[0] === moduleNumber.toString();
            });
            
            if (moduleScreens.length === 0) return 1;
            
            const screenNumbers = moduleScreens.map(screen => {
                const parts = screen.screen_number.toString().split('.');
                return parseInt(parts[1]);
            });
            
            return Math.max(...screenNumbers) + 1;
        }

        // Function to show the edit lesson screen modal
        function editLessonScreen(screenId) {
            const screen = lessonScreensData.find(s => s.lesson_screen_id === screenId);
            if (!screen) return;

            const modal = new bootstrap.Modal(document.getElementById('lessonScreenModal'));
            document.getElementById('lessonScreenModalLabel').textContent = 'Edit Lesson Screen';
            document.getElementById('lessonScreenId').value = screenId;
            document.getElementById('screenNumber').value = screen.screen_number;
            document.getElementById('screenTitle').value = screen.screen_title;
            document.getElementById('screenDescription').value = screen.screen_description || '';
            document.getElementById('screenDuration').value = screen.screen_duration || '';

            if (screen.screen_url) {
                document.getElementById('contentType').value = 'url';
                document.getElementById('screenUrl').value = screen.screen_url;
                document.getElementById('textContentSection').classList.add('d-none');
                document.getElementById('urlContentSection').classList.remove('d-none');
            } else {
                document.getElementById('contentType').value = 'text';
                document.getElementById('screenContent').value = screen.screen_content?.content || '';
                document.getElementById('textContentSection').classList.remove('d-none');
                document.getElementById('urlContentSection').classList.add('d-none');
            }

            modal.show();
        }

        // Function to show delete confirmation modal
        function deleteLessonScreen(screenId) {
            const screen = lessonScreensData.find(s => s.lesson_screen_id === screenId);
            if (!screen) return;

            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            const confirmButton = document.getElementById('confirmDelete');
            
            // Update modal content to show screen details
            document.getElementById('deleteConfirmModal').querySelector('.modal-body').innerHTML = `
                Are you sure you want to delete this lesson screen?<br><br>
                <strong>Screen Number:</strong> ${screen.screen_number}<br>
                <strong>Title:</strong> ${screen.screen_title || 'Untitled'}<br><br>
                This action cannot be undone.
            `;

            // Remove any previous event listeners
            const newConfirmButton = confirmButton.cloneNode(true);
            confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);

            // Add new event listener
            newConfirmButton.addEventListener('click', async () => {
                try {
                    const response = await fetch(`http://127.0.0.1:8000/api/v1/lesson-screens/${screenId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        // Remove the screen from lessonScreensData
                        lessonScreensData = lessonScreensData.filter(s => s.lesson_screen_id !== screenId);
                        
                        // Refresh the display
                        displayLessonScreensByModuleNumber();
                        
                        // Show success message
                        showAlert('success', 'Lesson screen deleted successfully!');
                        
                        // Close the modal
                        modal.hide();
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to delete lesson screen');
                    }
                } catch (error) {
                    console.error('Error deleting lesson screen:', error);
                    showAlert('danger', error.message);
                }
            });

            modal.show();
        }

        // Add event listener for the save button
        document.getElementById('saveLessonScreen').addEventListener('click', async function() {
            const form = document.getElementById('lessonScreenForm');
            
            // Basic form validation
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Get form data - matching exact database schema
            const screenData = {
                screen_number: document.getElementById('screenNumber').value,
                screen_title: document.getElementById('screenTitle').value || null,
                screen_description: document.getElementById('screenDescription').value || null,
                screen_duration: document.getElementById('screenDuration').value || null
            };

            // Handle content based on type
            const contentType = document.getElementById('contentType').value;
            if (contentType === 'text') {
                const content = document.getElementById('screenContent').value;
                // Format screen_content as an array
                screenData.screen_content = content.trim() ? [content.trim()] : null;
                screenData.screen_url = null;
            } else {
                const url = document.getElementById('screenUrl').value;
                if (!url || !url.trim()) {
                    showAlert('danger', 'Please upload a file first');
                    return;
                }
                screenData.screen_url = url.trim();
                screenData.screen_content = null;
            }

            try {
                const screenId = document.getElementById('lessonScreenId').value;
                let response;

                // Log the request data
                console.log('Sending data to API:', {
                    method: screenId ? 'PUT' : 'POST',
                    url: screenId 
                        ? `http://127.0.0.1:8000/api/v1/lesson-screens/${screenId}`
                        : 'http://127.0.0.1:8000/api/v1/lesson-screens',
                    data: screenData
                });

                if (screenId) {
                    // Edit existing screen
                    response = await fetch(`http://127.0.0.1:8000/api/v1/lesson-screens/${screenId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(screenData)
                    });
                } else {
                    // Create new screen
                    response = await fetch('http://127.0.0.1:8000/api/v1/lesson-screens', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(screenData)
                    });
                }

                // Log the raw response
                console.log('API Response status:', response.status);
                const responseText = await response.text();
                console.log('API Response text:', responseText);

                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    console.error('Failed to parse API response:', e);
                    throw new Error('Invalid API response format');
                }

                if (!response.ok) {
                    console.error('API Error Response:', responseData);
                    throw new Error(
                        responseData.message || 
                        responseData.error || 
                        responseData.detail ||
                        'Failed to save lesson screen'
                    );
                }

                // Update local data
                if (screenId) {
                    const index = lessonScreensData.findIndex(s => s.lesson_screen_id === parseInt(screenId));
                    if (index !== -1) {
                        lessonScreensData[index] = { ...lessonScreensData[index], ...responseData.data };
                    }
                } else {
                    lessonScreensData.push(responseData.data);
                }

                // Refresh the display
                displayLessonScreensByModuleNumber();

                // Show success message
                showAlert('success', `Lesson screen ${screenId ? 'updated' : 'created'} successfully!`);

                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('lessonScreenModal'));
                modal.hide();
            } catch (error) {
                console.error('Error saving lesson screen:', error);
                showAlert('danger', `Error: ${error.message}`);
            }
        });

        // Function to show alerts
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(alertDiv);

            // Remove the alert after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Add form validation listeners
        document.getElementById('screenNumber').addEventListener('input', function(e) {
            // Remove validation - allow any numbering format
            e.target.setCustomValidity('');
        });

        document.getElementById('screenUrl').addEventListener('input', function(e) {
            const value = e.target.value;
            if (document.getElementById('contentType').value === 'url' && value) {
                try {
                    new URL(value);
                    e.target.setCustomValidity('');
                } catch {
                    e.target.setCustomValidity('Please enter a valid URL');
                }
            } else {
                e.target.setCustomValidity('');
            }
        });
    </script>
</body>
</html>